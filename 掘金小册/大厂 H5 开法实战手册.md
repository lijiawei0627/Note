# 一、大厂 H5 开发概述

## H5 开发及其前世今生

![H5 开发的前世今生](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/3/2/161e5e2bebec560f~tplv-t2oaga2asx-watermark.awebp)

在腾讯，「H5 开发」有设立对应的实体岗位：「[UI 开发工程师](https://www.lagou.com/jobs/2634151.html)」，这个岗位早在两三年前由「网页重构工程师」演变而来，最早出现在 SNG（社交网络事业群）的用户体验设计部（[ISUX](https://isux.tencent.com/)）。与阿里和百度不同的是，腾讯的岗位职能分得比较细，传统的「网页重构工程师」虽然也属于前端范畴，但其工作职责主要负责静态网页制作（设计稿还原成为网页）和少量的 JavaScript 脚本逻辑开发，但随着 HTML5 和 CSS3 相关技术标准的出现与普及，重构工程师除了前面提及的基本工作，还要肩负「CSS3 动效开发」等 UI 相关的工作，「重构」的工作定义已然无法契合新时代的要求，于是便有了「H5 开发」的概念。

在京东，前端开发岗目前尽管没有细分出「H5 开发工程师」或「UI 开发工程师」这种实体的职位，但为了针对性地招聘人才，一些技术部门（如凹凸实验室）仍然会以「[H5 开发工程师](https://aotu.io/join/)」或「[H5 前端开发工程师](https://aotu.io/join/)」来招人。「H5 开发工程师」的职责要求其实与腾讯的「UI 开发工程师」基本一样，未来也许会统一沿用腾讯「UI 开发工程师」的叫法并设立相应的实体职位。「H5 开发」其实不太需要后端开发经验（有则为加分项），偏向界面还原制作、前端脚本逻辑的实现，同时与谷歌 2017 年提出的新岗位-动效设计师（[Motion Designer](https://design.google/jobs/motion-designer/)）也有交集，要求具备动效设计以及开发的能力，一句话来概括就是「基于 HTML5、CSS3 等网页技术，负责可视化 UI 界面及动效的开发」。

我们可以用一张图来直观表达「H5 开发」相关岗位的具体工作内容，如下：

![H5 开发内容示例](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/3/2/161e63ab485d5a19~tplv-t2oaga2asx-watermark.awebp)

一名合格的「H5 开发工程师」不仅需要会做「PC 端网页」、「移动端网页」，还需要会做各类强交互、多动效的「 [HTML5 营销活动页面](https://cases.aotu.io/)」，甚至还要做动效及脚本逻辑复杂的「[HTML5 小游戏](https://cases.aotu.io/cates/%E6%B8%B8%E6%88%8F%E5%9E%8B/index.html)」。

## H5 开发的能力模型

岗位划分了员工的专业范畴，而某个岗位的职位等级则划分了员工在其专业范畴上的能力及资历的高低深浅。这就是为什么京东、腾讯等公司会开设专业晋升通道，制定每个职级的能力模型，并以此来评估人们在其专业范畴上的综合水平。

而对于职位本身的专业能力要求，我们也同样可以梳理出相应的评估模型，了解这个模型，一方面可以帮助大家定位自己在某个专业方向上的水平和位置，而另一方面则可以作为岗位招聘者面试时对应聘者能力定位的初步评判依据。

参考前面提及的「H5 开发」相关岗位的具体工作内容，我们大致可以梳理出「H5 开发」的能力模型，如下：

![H5 开发能力模型](https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2018/3/6/161f90458e69df9b~tplv-t2oaga2asx-watermark.awebp)

这个能力模型长着一张三角脸，往下代表能力的基础性，往上代表能力的进阶。其中「基础页面开发」、「响应式页面开发」、「滑屏应用开发」以及「动画效果开发」是岗位的基础能力要求，「游戏开发」是高阶能力要求。换一个说法，掌握「基础页面开发」，我们就能应付「PC 端网页」的开发；掌握「响应式页面开发」，我们可以撸「移动端网页」；掌握了「滑屏应用开发」以及「动画效果开发」，我们能开发各类强交互、多动效的「 [HTML5 营销活动页面](https://cases.aotu.io/)」；而掌握了「H5 游戏开发」，我们才能做动效及脚本逻辑复杂的「[HTML5 小游戏](https://cases.aotu.io/cates/%E6%B8%B8%E6%88%8F%E5%9E%8B/index.html)」。

具备基础能力要求的同学，只能说拿到了岗位应聘的敲门砖，能否进到门内，要看有没有具备高阶能力的同学与你竞争；而兼具基础能力和高阶能力的同学，应聘的时候已然是半条腿迈进了门。另外半条腿，则取决于通用能力方面（如沟通能力、稳定性等）的评估，以及薪资要求是否与职级评定相匹配等非技术方面的因素。

需要提一下的是，上面并没有把「性能优化」考虑进去，因为「性能优化」是每一个开发岗位所必需的通用意识和能力，并非「H5 开发」所特定的要求。

是不是有点像打怪通关升级？越往上说明你功力越深厚，竞争力越大。

问题是，我们该如何达成这些能力？有没有对应的指导方向或案例借鉴？

这本小册将围绕「基础页面开发」、「响应式页面开发」、「滑屏应用开发」以及「动画效果开发」这 4 大基础能力展开叙述。「H5 游戏开发」以 [微信小游戏开发入门：从 0 到 1 实现井字棋游戏](https://juejin.im/book/5b7be023e51d4538850305d0/section/5b7be024e51d45389400165b) 小册独立解读，有兴趣的读者可以关注下。

下面先从「基础页面开发」说起。

# 二、基础页面开发

「基础页面开发」的能力可以定义为：

> 依据设计稿（PSD 或 Sketch）及交互要求，利用 JavaScript、HTML 和 CSS 等技术将设计稿高保真转换为网页的能力。

该能力是前端开发工程师的立业之本，自然也是「H5 开发」最最基础的要求。然而虽然是最基础的能力要求，平时我们却会发现身边的前端同学对它掌握十分到位的却是为数不多，要知道「做出一个页面」和「做好一个页面」是两码事。

当然，偏脚本开发方向的前端开发工程师可能不会要求精通「基础页面开发」，但至少也需要了解一个网页的基础构成，熟悉 HTML、CSS 在网页开发中各自所承担的角色及其相应用处。

除了熟练使用 JavaScript、HTML 和 CSS 等基础的网页技术，「基础页面开发」另一个非常重要的技能是「切图」，不会「切图」意味着我们无法将设计稿中的图层元素转换成为网页中所需要的图片，将设计稿高保真转换成为网页也就成了天方夜谭。

接下来通过一个案例说明「基础页面开发」是如何涵盖「切图、HTML 和 CSS」这些技能点的，JavaScript 在本小节不是核心故不做阐述。

通常我们会从视觉设计师手中拿到 PSD 设计稿，然后根据设计稿及设计师提供的相关视觉规范说明，一步步将其还原成真实网页。

例如这样一个 PC 站点的设计稿案例（点击放大图片，首屏的 MM 是不是很赞(✿◡‿◡)）：

![视觉案例](https://user-gold-cdn.xitu.io/2018/2/8/1617562903ac620a?w=940&h=4680&f=png&s=2375086)

我们分 5 个步骤来完成这个案例设计稿的页面开发。

## 步骤1 - 设计稿审查

> 看到帅锅美驴，不要急着瞪眼流口水，拿到一个设计稿，也不要急于动手。

我们需要站在开发者的角度，先做一个初步的设计稿审查，其目的及意义主要有两个：

* 了解设计稿的开发友好性

  帮助视觉设计师发现并指出有哪些地方的设计对开发不友好，例如是否存在展示缺陷（缺乏经验的视觉设计师一个常见的问题是没有考虑按钮或标签文字数量的溢出情况）？是否开发成本高或者根本无法实现？

* 了解设计稿的排版布局及内容构成

  帮助自己全局理解页面的设计细节，特别是排版布局及内容构成。利用模块化的思想将设计稿解构成一个个组件，并明确每一个组件的可复用性，包括可复用的范围。

这里着重说下第 2 点，为了更快更直观地帮助自己「了解设计稿的排版布局及内容构成」，可以先将网页的排版布局及内容构成抽象成线框图。

我们上面的设计稿案例可大体上抽象成（点击放大图片）：

![排版布局抽象为线框图](https://user-gold-cdn.xitu.io/2018/2/8/1617564839c4cd7c?w=940&h=4680&f=png&s=2060412)

### 跨页面可复用组件

参考上述的设计稿线框图，我们可以提取出如下的「跨页面可复用组件」：

1.  Header - 顶部导航

![header](https://user-gold-cdn.xitu.io/2018/2/8/1617566573c3eabd?w=940&h=181&f=png&s=25360)

2.  Footer - 底部信息

![footer](https://user-gold-cdn.xitu.io/2018/2/8/16175678573f1372?w=940&h=349&f=png&s=36083)

### 当前页面可复用组件

除去跨页面可复用的组件，剩余的区域，我们可以进一步抽出当前页面可复用的组件，以减少后续重复性的开发工作。

参考上述的设计稿线框图，我们可以提取出如下「当前页面可复用组件」：

1.  Billboard - 信息公告牌

![billboard](https://user-gold-cdn.xitu.io/2018/2/8/1617568d29e97ced?w=330&h=206&f=png&s=12312)

2.  Ad-board - 商品广告位

![adboard](https://user-gold-cdn.xitu.io/2018/2/8/16175698c17070cc?w=225&h=506&f=png&s=92448)

设计稿审查的过程中，如何将内容模块按照合适的颗粒度抽离成为组件，并确定其可复用性及复用范围？这是需要在日常工作中逐步培养的能力。

事实上，设计稿的审查流程一般都比较固定，我们可以将其整理成为团队内通用的审查清单：

*   确定设计稿的开发友好性（是否有还原成本高或无法还原的地方）
*   确定一些特殊的元素是否有合理的边界处理（如文案超出外层容器的边界怎么办）
*   确定页面的框架结构（Layout）
*   确定跨页面可复用的组件（Site Component）
*   确定当前页面可复用的组件（Page Component）
*   ...

## 步骤2 - 编写页面骨骼框架

设计稿审查完毕后我们就可以着手准备进行页面编码的工作啦。

我们可以把页面想象成一套房子，HTML 可以决定网页的框架结构（房子有几间房，各个区域的用途是什么），CSS 可以决定网页的样式（房子该如何装修，房间具体的尺寸是多少），而 JavaScript 则可以决定网页的具体交互和功能的实现（门如何打开，空调如何启动）。

在正式编写页面骨骼框架之前，我们需要了解以下几个重要的网页开发概念。

### 盒模型

HTML 文档中的每个元素都可以被描绘成矩形盒子，这些矩形盒子通过一个模型来描述其占用的空间，这个模型称为标准盒模型。盒模型通过四个边界来呈现元素的大小：margin（外边距）、border（边框）、padding（内边距）、content（内容区域），如下图所示：

![合模型](https://user-gold-cdn.xitu.io/2018/2/8/16175749f863d31f?w=1120&h=780&f=png&s=96176)

那么计算一个盒子的宽高，是不是可以用以下公式呢？

```
盒子总宽度 = width + padding + border + margin

```

No~ 在 IE 浏览器下，IE 没有使用标准盒模型。它们认为的元素宽度 `width` 计算公式如下：

```
元素宽度 = width + padding + border
盒子总宽度 = 元素宽度 + margin

```

为了解决这个问题，CSS3 中新增了一个盒模型的计算方式：`box-sizing`

```
box-sizing: content-box | padding-box | border-box;
默认值：content-box

```

为了简单地规避元素盒模型大小可变性造成的网页排版问题，一般我们会在样式重置的规则中，将盒模型设置成 `border-box`，添加如下规则：

```
*, *:before, *:after {
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}

```

设置成 `border-box` 之后的盒子宽度计算公式如下：

```
盒子总宽度 = width

```

不管 `margin + border + padding + content-width` 大于还是小于元素宽度 `width`，盒子的总宽度始终固定为 `width`。

以案例中的广告位模块为例，当盒模型设置成 `border-box` 之后：

![border-box](https://user-gold-cdn.xitu.io/2018/2/8/1617578eb500364b?w=530&h=570&f=png&s=139459)

### 布局

我们可以把网页理解成是由一个个盒子排列组合而成的，那么盒子之间又是怎么排列布局的呢？

网页常见的布局方式大概有五种：普通文档流布局、浮动布局（Float）、绝对布局（Absolute）、弹性布局（Flex）、网格布局（Grid）。

* 普通文档流布局

  默认的布局方式，由块级元素（`display: block`）和行内元素（`display: inline`）等组成，元素之间按照从左到右，从上到下的顺序排列。

* 浮动布局

  相对于普通文档流布局，浮动布局会脱离普通文档流，分为左右浮动，一般会在普通文档流布局的上面进行界面的布局，如果想避免浮动布局遮盖普通布局的情况，可以考虑使用清除浮动。

* 绝对布局

  元素使用 `position: absolute` 属性进行绝对布局，使用绝对布局的元素会脱离文档流，其定位是参考祖先元素中 `position` 为非 `static` 值的第一个元素。

* 弹性布局

  也称 Flex 布局，是一个完整的模块，而不是一个单一属性，其中有的属性是设置在父元素上，有些则是设置在子元素上。如果我们说传统的布局是建立在块级元素和行内元素的文本流上，那么 Flex 布局就是建立在 `flex-flow` 的轴方向上的。

* 网格布局

  是用于制定行与列的二维 CSS 布局方法，可以将页面分割成数个主要的区域，或者用来定义组件内部元素间的大小、位置和图层之间的关系。

以上是常用的五种网页布局方法，在实际项目中，我们应该根据场景选择适当的方法。

### 语义化

HTML 的标签虽然不多，但在编写的过程中，也会时不时犹豫应该使用 `div` 还是 `p` 标签，是使用 `span` 还是 `i` 标签？不管使用哪个标签，大体上都能实现想要的效果。

HTML 语义化就是根据具体的内容，选择合适的标签进行代码的编写，这样既能便于开发者阅读和维护，也能让搜索引擎的爬虫更好地识别。简单的说，就是可以让机器更容易读懂网页内容。

如果用语义化的标签编写网页结构，可以写成如下结构：

![语义化](https://user-gold-cdn.xitu.io/2018/2/8/161757aefb39a574?w=1040&h=946&f=png&s=62113)

## 步骤3 - 填充网页血肉内容

HTML 结构确定之后，我们需要进一步往页面中填充设计稿的内容，于是「切图」便成为我们「H5 开发」的必备技能。每个人都有自己熟悉的一套切图流程，但你是否考虑过更优、更高效的切图技巧呢？

Photoshop 更新迭代至今，Adobe 已为我们切图提供了几种便利的方法，下面会一一介绍，也欢迎大家在留言区交流其他的切图方法。

### 方法1 - Extract Assets 资源生成器

Extract Assets 是 Photoshop CC 2014 版本新增的一个特性，主要用来快速导出适用于 Web 和屏幕设计的资源，你可以用它导出 JPG、PNG、GIF，甚至是 SVG 图像资源。

通过 `Extract Assets`，你可以：

*   将 PSD 中的图层或图层组导出为一个或多个的图像资源
*   导出 JPG、PNG、GIF 或 SVG 类型的图像资源
*   为所有图像资源设置 1x、2x 等多分辨率的版本
*   预览每个图像资源
*   轻松将图像资源导出到你首选的文件夹中
*   确保每当 PSD 发生变化时，被导出的资源都能得到自动更新

#### 使用方法

按照以下步骤启用 `Extract Assets` 生成图像资源。

1.  启用 `Extract Assets`

![Extract Assets](https://user-gold-cdn.xitu.io/2018/2/8/161757d473a1c9cb?w=1732&h=1394&f=png&s=256637)

2.  打开 PSD 文件后，选择「文件」 > 「生成」 > 「图像资源」

![生成图像资源](https://user-gold-cdn.xitu.io/2018/2/8/161757e50a8496de?w=2200&h=2040&f=png&s=1663442)

3.  更改图层或图层组的名字为适当的文件格式扩展名（.jpg、.png 或 .gif 等）

![图层名](https://user-gold-cdn.xitu.io/2018/2/8/161757f01b7975fe?w=2420&h=2166&f=png&s=750397)

资源生成器默认会在 PSD 的同一层目录下创建 assets 文件夹，如图：

![assets](https://user-gold-cdn.xitu.io/2018/2/8/161757ff67b6a0cc?w=1824&h=812&f=png&s=393676)

经过以上步骤，切图工作就完成了！切图只需要简单的三步：

*   打开 PSD 文件
*   打开 「生成 > 图像资源」
*   更改图层或图层组的文件名

#### Extract Assets 进阶

1.  从一个图层或图层组中生成多个资源，请用半角逗号分隔该图层或图层组的名称

```
music.png, music.jpg, music_on.png

```

2.  图像资源保存到子文件夹中

```
子文件夹/music.png

```

3.  指定图像品质和大小参数

默认情况下， JPEG 资源会以 90% 品质生成， PNG 资源会以 32 位图像生成， GIF 资源则会以基本 Alpha 透明度生成

![图像品质](https://user-gold-cdn.xitu.io/2018/2/8/1617582deeecaf5d?w=717&h=257&f=png&s=23899)

我们可以通过以下办法设置 JPEG 资源的参数：

*   添加所需的输出品质作为资源名称的后缀：jpg(1-10) 或者 jpg(1-100%)，例如：

```
music.jpg5
music.jpg50%

```

*   添加所需的输出图片大小（相对大小或者支持的单位：px, in, cm 和 mm）作为该资源名称前缀。Photoshop 会相应的缩放图像，例如：

```
200% music.png
240x300 music.png

```

注意：前缀和资源名称之间要添加一个空格字符

4.  为资源指定默认位置

可以为生成的资源指定文件的默认位置，例如想将图层导出到 `hi-res/` （存放二倍图，并加上 @2x 的后缀），`lo-res/` 存放缩小 50% 的图标，可进行如下配置：

A. 创建空图层  
B. 更改空图层的名称为 `default hi-res/@2x + 50% lo-res/`

### 方法2 - Export Artboards, Layers, and more

Photoshop CC 2015 版本之后添加了 Artboards 功能，有点类似 `Sketch` 里面的 Artboards。具体使用方法类似 `Sketch` 的 `Export` 功能，右键点击所需要导出的图层或图层组，点击弹出菜单中的 `Export As` 或 `导出为` 即可。

### 方法3 - PS 动作切图

细心的同学可能会发现，用 `Extract Assets` 切图存在一个问题，它只能切画布范围内的资源，超出画布的部分会直接被裁减掉，如下图：

![PS 动作切图](https://user-gold-cdn.xitu.io/2018/2/8/1617587052ae256f?w=1924&h=1440&f=png&s=439158)

如果想切完整的图片该怎么办？建议用原始的「导出图层」的方式来切图，步骤如下：

1.  右键点击图层或图层组
2.  选择转换为智能对象
3.  编辑内容
4.  导出图片

为了避免重复劳动，我们可以用 PS 录制一个切图的动作，如图：

![PS 录制动作](https://user-gold-cdn.xitu.io/2018/2/8/1617587f345f2d5b?w=434&h=350&f=png&s=32927)

顺利的话，我们通过 PS 的动作切图，可以得到如下结果：

![PS 录制动作](https://user-gold-cdn.xitu.io/2018/2/8/1617589adfc7521f?w=2296&h=1590&f=png&s=589721)

## 步骤4 - 润色

编写 CSS 是前端开发中，比较愉快的一步。在此过程中，你可以一步步见证代码神奇的力量。编写可用的 CSS 比较容易，但是要维护它却不简单。

CSS 是一种定义样式结构，被用于描述网页上信息的排版方式的语言。由于其声明属性的方式不具备编程语言流程性控制的特点，而且自身「层叠」的特性，难以写出低耦合度的代码。不好好组织，容易造成不同地方的 class 相互影响，引起样式冲突等问题。所以 CSS 命名是样式代码组织中最重要的一环。

### BEM

在各类 CSS 命名规范中，BEM 命名规范被更多人所接受。

BEM 是一种基于组件的命名方法，它的基本思想是将用户界面划分成独立的模块，即使是复杂的用户界面，也能让开发过程变得简单、快速。并且可以在一定程度上提高代码的可复用性，而不用纯粹的复制粘贴。

BEM 的意思就模块（Block）、元素（Element）、修饰符（Modifier），使用这种命名方式可以让 CSS 的类名变得有实际意义且能自我解释，具有更高的开发友好性。

```
Block - 模块，名字的单词之间用 `-` 符号连接
Element - 元素，模块中的子元素，用 `__` 符号连接
Modifier - 修饰符，表示父元素或子元素的其他形态，用 `--` 符号连接

```

在没用 BEM 之前，我们可能会这样组织 CSS 类名：

```
<!-- S Search Bar 模块 -->
<div class="search-bar">
  <input class="input">
  <!-- / input 输入框 -->
  <button class="btn">
  <!-- / button 搜索按钮 -->
</div>
<!-- E Search Bar 模块 -->

```

上述写法虽然也给 class 赋予了一定的语义，但容易产生样式冲突的情况。

用 BEM 命名重写之后：

```
<!-- S Search Bar 模块 -->
<div class="search-bar">
  <input class="search-form__input"/>
  <!-- / input 输入框子元素 -->
  <button class="search-form__button"></button>
  <!-- / button 搜索按钮子元素 -->
</div>
<!-- E Search Bar 模块 -->

```

这样命名的好处是，模块语义化了，便于后期的维护，而且减少了 CSS 样式的层层嵌套，提升了网页的渲染效率。

通常在开发中使用 BEM 命名方法，会搭配 CSS 的预处理语言，如 SCSS 等。这可以一定程度上解决手写冗长命名的繁琐。

```
// 以下是 SCSS 代码
.search-bar {
  &__input { ... }
  &__button { ... }
}

```

将 BEM 用于中大型项目之后，我们会发现，当嵌套的层级越多时，类名也会越长，这给编写 `HTML` 代码带来了一些麻烦，同时也增加了 `HTML` 的文件大小。

那么问题来了，如何解决 BEM 命名冗长的问题？

### 姓氏命名法

为了进一步简化 CSS 的命名，我们凹凸实验室团队推广的 CSS 命名规范并不严格遵循 BEM 规范，不强制使用两个下划线「\_ \_ 」来分隔 B 和 E，而 E 和 M 之间也不一定要用两个中划线做分隔「- -」。

如：

![姓氏命名法](https://user-gold-cdn.xitu.io/2018/2/8/1617591ffe4caa75?w=493&h=122&f=png&s=47892)

老师，简化版的 BEM 好像也没有解决命名冗长的问题呀？

确实，如果按照这种继承的写法，再结合「给小孩取名」的生活场景，会出现下面的情况：

有位同学的名字叫「李小璐」，他的儿子名字叫「李小璐乃亮」，他的孙子叫「李小璐乃亮皮几万」。。。

而事实上，他的孩子只需要保留「李」姓就可以了，名字是可以随便取的。

所以在纠结怎么给一个元素做 CSS 命名的时候，联想一下我们身边的姓名是怎么起的吧。我们凹凸实验室在业务中推广使用的「姓氏命名法」也因此而诞生。

![姓氏命名法](https://user-gold-cdn.xitu.io/2018/3/6/161f8ff1517a16c9?w=1442&h=682&f=jpeg&s=61130)

如果要关联上 BEM 命名方法，姓氏命名法中的 Block 就是「姓」，Element 就是「名字」，而 Modifier 就表示这个人的某种状态，例如：「范冰冰 - - 很美」。

**如何优化？**

对于上面 **app\_market\_answer** 的案例，我们可以确定模块的姓氏是「app\_market\_answer」，名字随意取的话，我们可以尝试如下优化：

```
<div class="app_market_answer">
  <div class="app_market_secheader"></div>
  <div class="app_market_answer_list">
    <div class="app_market_answer_item">
      <div class="app_market_answer_itop"></div>
      <div class="app_market_answer_imid"></div>
      <a href="javascript:;" class="app_market_answer_ibtn">去围观</a>
    </div>
  </div>
</div>

```

我们将 **app\_market\_answer\_item\_top** 改成了 **app\_market\_answer\_itop** ，将 **app\_market\_answer\_item\_middle** 改成了 **app\_market\_answer\_imid** ，只保留了「姓」。

**如何进一步优化？**

姓氏可以进一步简化，例如 **app\_market** 可以看成是「复姓」，我们有时候为了书写便利，可以将两个单词的首字母结合在一起形成一个新的「单姓」，如 **am** 。追求便利的副作用之一是牺牲了代码的可读性。如果你做的项目或页面没有太大的二次维护或者交叉维护的可能性，推荐做此简化。

对于上面 **app\_market\_answer** 的案例，我们可以进一步优化成：

```
<!-- am = app_market -->
<div class="am_answer">
  <div class="am_secheader"></div>
  <div class="am_answer_list">
    <div class="am_answer_item">
      <div class="am_answer_itop"></div>
      <div class="am_answer_imid"></div>
      <a href="javascript:;" class="am_answer_ibtn">去围观</a>
    </div>
  </div>
</div>

```

**小结**

*   ClassName 的命名应该尽量精短、明确，以英文单词命名，且全部字母为小写，避免意义不明的缩写
*   单词之间统一使用下划线 `_` 或 `-` 连接
*   学习 BEM 的思想，参考使用姓氏命名法规范
*   定义样式模块，提高代码的可复用性

## 步骤5 - 兼容性测试

兼容性测试是网页开发中必不可少的一步，我们主要关注两点：

1.  页面在各个浏览器中，以及不同分辨率下是否能正常显示（HTML / CSS 兼容性）
2.  网页的功能是否能在各个浏览器中正常使用（JavaScript 兼容性）

「IE 虐我千百遍，我待 IE 如初恋」，这是圈内流传比较广的一句话，可见要做好网页的兼容性是件很不容易的事情。除了 IE 上有比较多的兼容性问题，移动端上的 Android 低版本浏览器也会有较多的问题。

所以在开发之初，我们要大致了解网站最终的用户群体有哪些，他们会使用怎样的设备，会用什么浏览器访问我们的网站？以此来决定我们是否要保持对低端浏览器的兼容性。

兼容性的基本原则是：

> 渐进增强与平稳退化。

在低端浏览器能够保持可用性和可访问性，然后再渐进增强，逐步增加功能及优化用户体验。

如果遇到兼容性问题，可以按如下步骤处理：

1.  确认触发的场景：什么浏览器，什么版本，什么情况下触发的问题，做到稳定复现。
2.  找出问题原因：是什么问题导致的，具体表现如何？
3.  确定解决办法：参考现成的解决方案，如哪些属性不能使用以及相应的 Hack 处理
4.  收集兼容性处理方法，积累成文档

## 小结

本小节通过「5 个基础页面开发的步骤」来阐述如何将一个设计稿案例转换成为网页，并给大家介绍了具有凹凸实验室特色的 CSS 样式命名方法：「姓氏命名法」。

掌握了「基础页面开发」，我们就拥有了「将设计稿变成保真网页」的能力，这就犹如学一门武功时迈出了第一步，有了良好的脉络根基，才可以继续学习更高级的招式技能。

# 三、响应式页面开发

响应式页面开发的能力可以定义为：

> 利用一套代码实现页面的布局和排版以适配不同分辨率的设备。

响应式页面开发要求我们解决两大问题：

*   为不同特性（如横屏还是竖屏等）的浏览器视窗使用不同的样式代码
*   让页面元素的尺寸能够依据浏览器视窗尺寸变化而平滑变化

本小节的学习目标是学会解决上述问题并能够开发这样一个经典的移动端响应式页面：

![响应式页面](https://user-gold-cdn.xitu.io/2018/2/8/16175aa4154b7972?w=429&h=877&f=png&s=85282)

我们分 3 个步骤来实现这样一个响应式页面。

## 步骤 1 - 添加 viewport meta 标签

在页头 `head` 标签内添加 viewport meta 标签是实现响应式页面的第一步。

viewport meta 标签源于 Apple 公司，用来定义 iOS Safari 浏览器展示网页内容的可视范围及缩放比率。它虽然没有成为W3C标准，但是被其他绝大多数的移动端浏览器所支持（目前已知 IE Mobile 10 不支持）。W3C 尝试将 viewport meta 标签的功能进行标准化并通过 CSS 的 @viewport 规则来实现同样的功能，但这个标准目前还在草案中，兼容性也没有 viewport meta 标签好。

### PageSpeed 准则

Google 网页性能分析工具 [PageSpeed Insights](https://developers.google.com/speed/pagespeed/insights/) 的其中一条准则就是：

网页应在 head 标签内添加 viewport meta 标签，以便优化在移动设备上的展示效果，其推荐的设置为：

```
<meta name="viewport" content="width=device-width, initial-scale=1">

```

### 扩展阅读

*   Mozilla[《Using the viewport meta tag to control layout on mobile browsers》](https://developer.mozilla.org/en-US/docs/Mozilla/Mobile/Viewport_meta_tag)
*   Google[《Configure the viewport》](https://developers.google.com/web/fundamentals/design-and-ux/responsive/#set-the-viewport)
*   Mozilla[《@viewport》](https://developer.mozilla.org/en-US/docs/Web/CSS/@viewport)

## 步骤 2 - 使用 Media Queries

Media Queries 是为指定特性的浏览器视窗应用指定样式的手段，可以看成是 CSS 样式的过滤器或拦截器，通常情况下它可以通过 「@media 规则」结合「6 个查询参数」来拦截设备的浏览器特性（如显示类型、视窗高度、视窗宽度、横竖屏等），藉此可以为不同的特性应用不同的样式代码（相当于为不同的设备应用了不同的 CSS 样式）。

### 6 个参数

参数名称

参数描述）

min-width

当视窗宽度大于或等于指定值时，@media 规则下的样式将被应用

max-width

当视窗宽度小于或等于指定值时，@media 规则下的样式将被应用

min-height

当视窗高度大于或等于指定值时，@media 规则下的样式将被应用

max-height

当视窗高度小于或等于指定值时，@media 规则下的样式将被应用

orientation=portrait

当视窗高度大于或等于宽度时，@media 规则下的样式将被应用

orientation=landscape

当视窗宽度大于高度时，@media 规则下的样式将被应用

### 2 种用法

方法 1，使用 link 标签，根据指定特性引入特定的外部样式文件

```
<link rel="stylesheet" media="(max-width: 640px)" href="max-640px.css">

```

方法 2，直接在 style 标签或 样式文件内使用 @media 规则

```
@media (max-width: 640px) {
  /*当视窗宽度小于或等于 640px 时，这里的样式将生效*/
}

```

### 样式断点

Media Queries 所使用的查询参数的临界值又可称为「样式断点」。 在响应式页面开发过程中，对于「样式断点」我们需要掌握 2 个重要的技巧：

依据目标设备的分辨率，制定一套合适的样式断点，并为不同的断点定制必要的 CSS 样式。 移动端优先的页面，可使用 min-width 查询参数从小到大来定义断点。 如果我们页面的响应式设计要涵盖从手机到高清大屏幕，什么样的「样式断点」比较合理呢？

我们可以从业界一些热门可靠的 CSS 框架中寻找参考答案，例如 [Bulma](https://bulma.io/)，其采用的「样式断点」有 5 个：

断点名称

断点描述）

mobile

移动设备断点，视窗宽度 ≤ 768 px

tablet

平板电脑设备断点，视窗宽度 ≥ 769 px

desktop

桌面电脑断点，视窗宽度 ≥ 1024 px

widescreen

宽屏电脑断点，视窗宽度 ≥ 1216 px

fullhd

高清宽屏电脑断点，视窗宽度 ≥ 1408 px

在实际工作中，「样式断点」的制定需要我们同视觉设计师一起沟通确认，因为视觉设计师可能需要根据不同的断点为页面设计不同的视觉表现。

### 一个小例子

如果针对 tablet 及以上的设备定制样式，我们就可以这样写了：

```
@media (min-width: 769px) {
  /* tablet 及以上的设备，页面背景色设置为红色 */
  body {
    background-color: red;
  }
}

```

### 课外作业

1.  使用桌面版的 Chrome 浏览器，打开 Google 的 [在线 Media Queries 例子](https://googlesamples.github.io/web-fundamentals/fundamentals/design-and-ux/responsive/media-queries.html) 直观感受下使用 Media Queries 的效果（请注意缩放浏览器窗口观察页面展示效果）
2.  了解 [Bulma](https://bulma.io/) 框架

### 扩展阅读

*   Google [《Responsive Web Design Basic》](https://developers.google.com/web/fundamentals/design-and-ux/responsive/)

## 步骤 3 - 使用 Viewport 单位及 rem

Media Queries 只解决了「为不同特性的浏览器视窗使用不同的样式代码」的问题，而 Viewport 单位及 rem 的应用，则是为了解决第二个问题：让页面元素的尺寸能够依据浏览器视窗尺寸变化而平滑变化。

关于 Viewport 单位及 rem 单位的基本概念，可通过下面的扩展阅读进行回顾复习。

BTW：本文所提及的 Viewport，译为「视窗」，其含义与扩展阅读中相关文章中的「视口」一致。

### 方法 1 - 仅使用 vw 作为 CSS 长度单位

在仅使用 vw 单位作为唯一 CSS 单位时，我们需遵守：

1.  利用 Sass 函数将设计稿元素尺寸的像素单位转换为 vw 单位

```
// iPhone 6尺寸作为设计稿基准
$vw_base: 375; 
@function vw($px) {
    @return ($px / $vm_base) * 100vw;
}

```

2.  无论是文本字号大小还是布局高宽、间距、留白等都使用 vw 作为 CSS 单位

```
.mod_nav {
    background-color: #fff;
    &_list {
        display: flex;
        padding: vw(15) vw(10) vw(10); // 内间距
        &_item {
            flex: 1;
            text-align: center;
            font-size: vw(10); // 字体大小
            &_logo {
                display: block;
                margin: 0 auto;
                width: vw(40); // 宽度
                height: vw(40); // 高度
                img {
                    display: block;
                    margin: 0 auto;
                    max-width: 100%;
                }
            }
            &_name {
                margin-top: vw(2);
            }
        }
    }
}

```

3.  1 物理像素线（也就是普通屏幕下 1px ，高清屏幕下 0.5px 的情况）采用 transform 属性 scale 实现

```
.mod_grid {
    position: relative;
    &::after {
        // 实现1物理像素的下边框线
        content: '';
        position: absolute;
        z-index: 1;
        pointer-events: none;
        background-color: #ddd;
        height: 1px;
        left: 0;
        right: 0;
        top: 0;
        @media only screen and (-webkit-min-device-pixel-ratio: 2) {
            -webkit-transform: scaleY(0.5);
            -webkit-transform-origin: 50% 0%;
        }
    }
    ...
}

```

4.  对于需要保持高宽比的图，应改用 padding-top 实现

```
.mod_banner {
    position: relative;
    // 使用padding-top 实现宽高比为 100:750 的图片区域
    padding-top: percentage(100/750);
    height: 0;
    overflow: hidden;
    img {
        width: 100%;
        height: auto;
        position: absolute;
        left: 0;
        top: 0; 
    }
}

```

由此，我们不需要增加其他任何额外的脚本代码就能够轻易实现一个常见布局的响应式页面，效果如下：

![vw和rem](https://user-gold-cdn.xitu.io/2018/2/8/16175d6ffdfe7c0e?w=1409&h=685&f=png&s=207733)

体验地址：[视口单位布局 —— vw 单位](https://jdc.jd.com/demo/ting/vw_layout.html)

> 友情提醒：桌面版 Chrome 支持的字体大小默认不能小于 12PX，可通过 「chrome://settings/ 显示高级设置－网络内容－自定义字体－最小字号（滑到最小）」设置后再到模拟器里体验 DEMO。

### 方法 2 - vw 搭配 rem，寻找最优解

方法 1 实现的响应式页面虽然看起来适配得很好，但是你会发现由于它是利用 Viewport 单位实现的布局，依赖于视窗大小而自动缩放，无论视窗过大还是过小，它也随着视窗过大或者过小，失去了最大最小宽度的限制，有时候不一定是我们所期待的展示效果。试想一下一个 750px 宽的设计稿在 1920px 的大屏显示器上的糟糕样子。

当然，你可以不在乎移动端页面在 PC 上的展现效果，但如果有低成本却有效的办法来修复这样的小瑕疵，是真切可以为部分用户提升体验的。

我们可以结合 rem 单位来实现页面的布局。rem 弹性布局的核心在于根据视窗大小变化动态改变根元素的字体大小，那么我们可以通过以下步骤来进行优化：

1.  给根元素的字体大小设置随着视窗变化而变化的 vw 单位，这样就可以实现动态改变其大小
2.  其他元素的文本字号大小、布局高宽、间距、留白都使用 rem 单位
3.  限制根元素字体大小的最大最小值，配合 body 加上最大宽度和最小宽度，实现布局宽度的最大最小限制

核心代码实现如下：

```
// rem 单位换算：定为 75px 只是方便运算，750px-75px、640-64px、1080px-108px，如此类推
$vw_fontsize: 75; // iPhone 6尺寸的根元素大小基准值
@function rem($px) {
     @return ($px / $vw_fontsize ) * 1rem;
}
// 根元素大小使用 vw 单位
$vw_design: 750;
html {
    font-size: ($vw_fontsize / ($vw_design / 2)) * 100vw; 
    // 同时，通过Media Queries 限制根元素最大最小值
    @media screen and (max-width: 320px) {
        font-size: 64px;
    }
    @media screen and (min-width: 540px) {
        font-size: 108px;
    }
}
// body 也增加最大最小宽度限制，避免默认100%宽度的 block 元素跟随 body 而过大过小
body {
    max-width: 540px;
    min-width: 320px;
}

```

体验地址：[https://jdc.jd.com/demo/ting/vw\_rem\_layout.html](https://jdc.jd.com/demo/ting/vw_rem_layout.html)

### 扩展阅读

*   Mozilla[《Length》](https://developer.mozilla.org/en-US/docs/Web/CSS/length)
*   凹凸实验室 [《利用视口单位实现适配布局》](https://aotu.io/notes/2017/04/28/2017-4-28-CSS-viewport-units/)

## 小结

在实际工作过程中，考虑到设计以及开发成本，视觉设计师是不大可能为每种不同分辨率的设备分别设计不同的稿子的，拿移动端页面来说，通常会以 iPhone 7 的分辨率（宽为 750 px）作为基准分辨率来出设计稿。因此「响应式页面开发」也便成为了移动互联网时代「H5 开发」的必备技能。

本小节所介绍的「利用 Viewport 单位及 rem 实现响应式页面」，相对于传统的 JavaScript 脚本结合 rem 的方式来得更简单优雅。

# 四、滑屏应用开发

滑屏应用开发的能力可以定义为：

> 利用 JavaScript 和 CSS3 来实现单页面应用的滑屏效果，包括上下滑屏、左右滑屏，以及局部元素的滑动切换效果。

滑屏 H5 应用在国内是异常火爆的一种内容展示交互形式，被广泛用于各类线上营销活动场景中。

滑屏应用开发要求我们：

*   至少要掌握主流滑屏组件（如 Swiper）的具体用法
*   能不依赖已有组件实现简易的滑屏效果，了解滑屏的技术细节

![滑屏应用示例](https://user-gold-cdn.xitu.io/2018/2/8/16175dc62f2b71d0?w=320&h=569&f=gif&s=2637794)

上图为基础的滑屏页面效果示例。

## 善用利器

在平时工作过程中，考虑到项目的紧迫性和实现成本，我们大多数时候会使用业界已有滑屏组件，如：

*   [Swiper](https://github.com/nolimits4web/Swiper)：Most modern mobile touch slider with hardware accelerated transitions.

其它更多滑屏组件的选择可查阅[《awesome-javascript》](https://github.com/sorrycc/awesome-javascript#sliders)。

基于 Swiper 组件，只需数行代码即可创建一个基础的「滑屏应用」，以上下滑屏为例:

**HTML (Jade)：约定的 HTML 结构**

```
div.swiper-container
  div.swiper-wrapper
    div.swiper-slide
    div.swiper-slide
    div.swiper-slide

```

**CSS (SCSS) ：指定滑屏的尺寸为视窗大小**

```
.swiper-container {
  width: 100vw;
  height: 100vh;
}

```

**JavaScript：初始化为竖直方向上的滑屏应用**

```
new Swiper('.swiper-container', {
  direction: 'vertical',
})

```

善用成熟的组件可以让我们免去从零实现滑屏效果的成本，并能保证开发速度和稳定性，解决 80% 的应用场景，但缺点是定制化成本较高，另外就是代码冗余，有时候你只用了它 20% 的功能，但却要加载其 100% 的体积。当然，如果我们的滑屏应用场景不需要做定制化效果，也不用太在意那几十 KB 的体积的时候，利用业界成熟组件是首选方式。

## 知其所以然

善用利器，我们只做到了知其然。有些时候现有的滑屏组件不一定能满足个性化的业务需求，我们不得不去做二次开发，甚至需要根据个性化需求重新开发一款适用当前应用场景的滑屏组件，这就要求我们知其所以然。

作为示例，接下来我们探索下如何实现一个简单的 swiper。

我们将滑屏应用的实现分为两大部分：

*   判断用户的手势动作
*   根据手势动作执行相应滑屏过渡动画

为了更易理解，大家可以先在移动端体验以下三个例子，然后再阅读下面内容。

*   滑屏应用例子 [swiper.js 版本](http://jdc.jd.com/lab/swiper/swiper_plugin/)
*   滑屏应用例子 [hammer.js 版本](http://jdc.jd.com/lab/swiper/swiper_hammer/)
*   滑屏应用例子 [无依赖版本](http://jdc.jd.com/lab/swiper/swiper_pure/)

![](https://user-gold-cdn.xitu.io/2018/3/6/161f909cde5960da?w=1442&h=602&f=jpeg&s=118355)

### 手势动作判断

手势动作判断是实现滑屏应用的核心逻辑。 对于上下滑屏应用，我们主要实现的手势动作有：瞬间的上下滑动和按住拖拽滑动。

瞬间的上下滑动除了要考虑滑动的始末位置，还要考虑时间间隔，即滑动速度。若满足一定的速度则代表用户是果断切换上下屏的动作，反之，则是犹豫保留在当前屏的动作。

我们看下核心代码，

```
var _this = this
var drag = false
var y0 = 0
var deltaY = 0
var time0 = 0

this.$swiper.on('touchstart', function (ev) {
  drag = _this.$swiper
  y0 = ev.touches[0].pageY
  time0 = new Date()  
})

this.$swiper.on('touchend', function (ev) {
  var interval = new Date() - time0
  drag = false
  // 拖拽完成后，判断移动方向、移动速度和移动距离等
  // 若划动速度满足，则执行上划或下划过渡动画。
  // 若划动速度不满足，则判断是否划动距离是否大于阈值(如 Swiper 容器的高度的一半)，若大于则执行上划或下划过渡画面，反之回到当前活跃块。
  _this.panEnd(deltaY, deltaY / interval)
})

this.$swiper.on('touchmove', function (ev) {
  if (drag) {
    deltaY = ev.touches[0].pageY - y0
    // 设置 .swiper-wrapper 按住拖拽的位移。
    _this.pan(deltaY)
  }
})

```

事实上，业界已经有许多很好用的判断手势动作的插件，如知名的 [hammer.js](https://hammerjs.github.io/) 或 [zepto](http://zeptojs.com/) 的 touch 模块。大家也可以通过阅读 [hammer.js](https://hammerjs.github.io/) 的源码来进一步学习手势动作判断处理的逻辑。

### 滑屏过渡动画

过渡动画是让滑屏效果更自然的必要手段。

实现过渡动画的常见方式有两种：CSS3 或 JavaScript 动画，我们下面以 CSS3 动画作为示例。

这个过程我们需要关注的是什么时候触发动画，以及动画偏移的量为多少。

假设当前活跃块的索引为 `activeIndex`，将其与 swiper 容器的高度相乘并取反，可得到 `.swiper-wrapper` 的偏移量，然后设置适当的 `CSS transition-duration` 属性即可轻松实现过渡动画效果：

```
this.translate = -(this.activeIndex * this.swiperHeight)
this.$swiperWrapper.css({
  'transform': 'translate3d(0, '+ this.translate +'px, 0)',
  'transition': 'transform '+ 0.3 +'s'
})

```

若想保证一个过渡完成后，才能接收用户的下一个操作，则可以增加 `animating` 属性。动画过渡前就将其设置为 `true`，然后在 `.swiper-wrapper` 的 `transitionend` 事件触发时再将其设置为 `false`：

```
this.$swiperWrapper.on('transitionend', function(ev) {
  if (ev.propertyName === 'transform') {
    _this.animating = false
  }
})

```

上述是最基本的位移过渡动画，你还可以依样画葫芦实现渐隐渐现、3D 翻转动画等。

### 源码分享

前面 3 个体验例子的源码放在 Coding.net 上，源码附注释，读者可以课后查阅。

*   滑屏应用例子源码 [Swiper 版本](https://coding.net/u/Jcc/p/swiper_plugin/git)
*   滑屏应用例子源码 [hammer.js 版本](https://coding.net/u/Jcc/p/swiper_hammer/git)
*   滑屏应用例子源码 [无依赖版本](https://coding.net/u/Jcc/p/swiper_pure/git)

## 一个实际案例

最后放一个典型的滑屏 H5 应用的实际案例 —— 京东 2018 校园招聘，供大家体验参考。

![京东2018校招](https://user-gold-cdn.xitu.io/2018/2/8/16175e90a6ae1715?w=375&h=667&f=jpeg&s=9577)

_（[京东 2018 校园招聘](http://wqs.jd.com/promote/201707/2018campus/index.html)）_

值得一提的是，这个滑屏 H5 案例使用了凹凸实验室自研开源的 [HTML5 构建工具 ELF](https://elf.aotu.io/) 进行构建，利用 ELF 提供的命令行工具，我们只需敲一个命令就可以搭建一个具有基础功能的滑屏应用，大大提升开发效率。

如果说 [Swiper](https://github.com/nolimits4web/Swiper) 是开发滑屏应用的利器，那么 [ELF](https://elf.aotu.io/) 则是开发 HTML5 应用的利器。

如果没有 Swiper，那么我们每次开发一个滑屏应用的时候，都要重新去写一遍滑屏手势的判断逻辑，还要重新写一遍滑屏的过渡动画。ELF 解决的是类似的问题，将搭建 HTML5 应用的重复过程自动化，将功能组件化、将交互形式模板化。它基于 Webpack 进行自动化构建，提供基础功能组件和脚手架案例模板；利用 ELF 提供的命令行工具 elf-cli，开发者可自由通过模板和组件的组合来快速定制开发各种 HTML5 场景应用。

实际上 ELF 本身基本上浓缩了前一个小节「响应式页面开发」和本小节「滑屏应用开发」的大部分内容，读者有兴趣可以移步 [ELF 官网](https://elf.aotu.io/) 进一步了解下 ELF 的功能特性。

## 性能贴士

在开发滑屏应用的时候，我们应该尽可能做到以下几点来保证页面的顺畅体验：

1.  做到延迟加载，避免浪费资源和并发加载资源数过高。
2.  做到预加载，预加载必要的资源，避免白屏。

在滑屏动画过渡期间，不要做繁重的任务，避免因占用资源过高而导致卡顿。

## 小结

本小节通过案例以及源码的方式，为大家介绍了如何利用业界优秀的滑屏开源组件「[Swiper](https://github.com/nolimits4web/Swiper)」来快速开发滑屏应用，同时也解读了滑屏应用的关键处理逻辑：手势判断处理。

至此，我们学习了 「H5 开发」能力模型的前三种基础能力，在实际工作过程中，当视觉设计师妹子扔给我们一个设计稿（PSD）时，至少心里不会慌慌了。回想下第 2 小节「基础页面开发」，我们知道如何将一个设计稿转换成为高保真网页；如果这个设计稿是一个移动端的稿子，需要适配各种手机设备，那么第 3 小节「响应式页面开发」给我们指引了方向；而如果它是一个单页面的滑屏 H5 活动，第 4 小节「滑屏应用开发」里可以找到相应的开发思路。

但是，如果这个设计稿里面包含了许多动画效果的设计元素，需要我们做各种动效，该怎么办？

# 五、动效开发 1：让它动起来

在现实生活中，人们的大脑习惯了被动态的东西所吸引，适当的动画效果可以为网页添加有价值的交互和反馈，提升用户的情感体验。

> 情感设计的主要目标是促进人与人之间的沟通，即便媒介是网页。一旦我们在这方面做得到位，电脑本身将回归背后，而网页的个性化将因此得到凸显。  
> —— Aarron Walter，[_Designing For Emotion_](https://abookapart.com/products/designing-for-emotion) 一书的作者

动画效果是情感设计的重要手段，从本小节开始，我们将为大家介绍「H5 开发」的第四个重要的能力 —— 「动画效果开发」，简称「动效开发」，即综合利用 JavaScript、CSS(3)、SVG、Canvas 等多种 Web 技术手段开发出动人的网页动态效果。

回想下我们第 1 小节提及的 「H5 开发」三角形能力模型，「动效开发」处在三角形的上部，毫无疑问这项能力越强，在此岗位中的竞争力越大。

动效开发 —— 先「动」而后「效」，为网页添加动态元素的方法有很多：

*   GIF、Flash —— 廉颇老矣，尚能饭否？
*   视频 —— 可远观而不可亵玩焉
*   CSS3 结合 JavaScript —— 当红小生

我们将把重心放在 CSS3 动画上面，因为 CSS3 在现如今的网页动效开发中占据着最为重要的一席，作为老大哥 CSS 的补充，它像是专门为「H5 开发」量身定制的动效武器。

拿起这件武器准备杀出一条血路之前，得先找到它的扳机在哪里。

## CSS3 Transition

在 CSS3 的世界里，让网页元素动起来的第一个方法是利用 `transition`，基于 `transition` 可以让元素的某个 CSS 属性从指定的开始状态过渡到特定的结束状态。我们将元素「从指定的开始状态过渡到特定的结束状态」这个过程简称为「状态变换」，注意这里的**过渡**，事实上 `transition` 便像是页面元素「状态变换」的润滑剂，如果没有 `transition`，元素「状态变换」的过程将会显得生硬而突兀（如下图中左边的小圆球，[查看 DEMO](https://codepen.io/mamboer/full/pLvLyv/)）。

![transition](https://user-gold-cdn.xitu.io/2018/3/10/1620f2835b9b7448?w=950&h=220&f=gif&s=97142)

`transition` 可作用于普通的 CSS 属性（如 `background` 、`opacity` ...），也可以作用于 CSS3 出现时新引入的 `transform` 属性，而利用后者可以实现 3D 的过渡效果。`transform` 属性就像是 CSS3 这个动效武器子弹里的火药，大家可以通过 [MDN](https://developer.mozilla.org/en-US/) 的 [《transform》](https://developer.mozilla.org/en-US/docs/Web/CSS/transform) 一文进行进一步地了解学习，务必做到深谙其门道，避免一知半解。

### 一个 3D 过渡动效例子

如前面所说，利用 `transition` 结合 `transform` 可实现元素的 3D 过渡动效，所以我们这个例子的目标是：利用 `transform` 属性画一个立方体，然后利用 `transition` 实现立方体的翻转效果。大家不妨打开 [CodePen](https://codepen.io/) 按照以下步骤亲自动手试试，或者直接 [查看 DEMO](https://codepen.io/mamboer/full/XEJqPy) 体会最终的结果。

#### 步骤 1 - 准备立方体的 HTML 代码

一个立方体（`.cube`）的 6 个面（`.cube-face`）。

```
<div class="demo">
  <div class="cube show-default">
    <div class="cube-face is-front"><img src="https://rawcdn.githack.com/o2team/misc/gh-pages/o2/img/mms/s1/1.jpg" alt="pic1"/></div>
    <div class="cube-face is-back"><img src="https://rawcdn.githack.com/o2team/misc/gh-pages/o2/img/mms/s1/2.jpg" alt="pic2"/></div>
    <div class="cube-face is-right"><img src="https://rawcdn.githack.com/o2team/misc/gh-pages/o2/img/mms/s1/3.jpg" alt="pic3"/></div>
    <div class="cube-face is-left"><img src="https://rawcdn.githack.com/o2team/misc/gh-pages/o2/img/mms/s1/4.jpg" alt="pic4"/></div>
    <div class="cube-face is-top"><img src="https://rawcdn.githack.com/o2team/misc/gh-pages/o2/img/mms/s1/5.jpg" alt="pic5"/></div>
    <div class="cube-face is-bottom"><img src="https://rawcdn.githack.com/o2team/misc/gh-pages/o2/img/mms/s1/6.jpg" alt="pic6"/></div>
  </div>
</div>

```

#### 步骤 2 - 利用 CSS(3) 将 6 个面组装成立体形状的立方体

> 这里使用了 SCSS 样式预处理语言，如果你正在 CodePen 上跟着做，注意将样式预处理器（CSS Preprocessor）配置成为 SCSS。

```
// demo styles
$cube-size: 300px;
$cube-radius: $cube-size / 2;
.demo {
  width: $cube-size;
  height: $cube-size;
  perspective: 1000px;
  position: relative;
  margin: 30px auto;
}
.cube {
  width: 100%;
  height: 100%;
  transform-style: preserve-3d;
  position: absolute;
  &-face {
    border: 2px solid #000;
    width: 100%;
    height: 100%;
    position: absolute;
    overflow: hidden;
    opacity: 0.6;
    backface-visibility: visible;
    &.is-front  {
      transform: translateZ( $cube-radius );
    }
    &.is-back   {
      transform: rotateX( -180deg ) translateZ( $cube-radius );
    }
    &.is-right {
      transform: rotateY( 90deg ) translateZ( $cube-radius );
    }
    &.is-left {
      transform: rotateY( -90deg ) translateZ( $cube-radius );
    }
    &.is-top {
      transform: rotateX( 90deg ) translateZ( $cube-radius );
    }
    &.is-bottom {
      transform: rotateX( -90deg ) translateZ( $cube-radius );
    }
  }
  img {
    width: 100%;
  }
}

```

至此，我们得到一个正面朝着我们的边长为 `300px` 的立方体，为了让它在网页上呈现 3D 的视觉效果，我们写了以下几行关键的代码：

1.  利用 3D 旋转 `rotateX` 或 `rotateY`，以及 Z 轴位移 `translateZ` 来衔接拼装立方体的每一个面
2.  设置每一个面的背面可见性：`backface-visibility: visible`，注意这里前一行代码 `opacity: 0.6` 是辅助性的，而 `backface-visibility` 属性的默认值其实即 `visible`，这里写出来便于大家理解代码。
3.  在立方体的父级元素上设置透视距离：`perspective: 1000px`
4.  在立方体上设置变形方式：`transform-style: preserve-3d`

以上关键代码的关键 CSS 属性，在小册后面的「聊一聊 3D」小节中会有进一步的解读，这里就不多说了。读者也可自行在 [MDN](https://developer.mozilla.org/en-US/) 上搜到具体的说明资料，建议结合资料和本例子亲自把玩体会。

#### 步骤 3 - 让立方体显得更立体点

为了让立方体默认看起来更立体点（不是单纯地正面对着我们），可以利用 `rotate` 将立方体在 X 和 Y 轴上各旋转 `15deg`，让它正面斜对着我们。

**注意**：以下代码需要合并到前面步骤 2 里的代码中去。

```
.cube {
  ...
  &.show-default {
    transform: translateZ( - $cube-radius ) rotateY( -15deg ) rotateX(-15deg);
  }
  &.show-left {
    transform: translateZ( - $cube-radius ) rotateY( 90deg );
  }
  &-face {
    ...
    opacity: 0.9;
    ...
  }
  ...
}  

```

我们给立方体新增了两个表示状态的类 `show-default` 和 `show-left`，分别表示它「默认的展示状态 - 正面斜对着我们」和「左面正对着我们」，读者可以依样画葫芦添加另外几个面对着我们的样式代码。

#### 步骤 4 - 设置立方体的 `transition` 属性

最后一步就是给立方体添加 `transition` 属性，让它的状态变换拥有过渡动画效果。

通过查阅 [MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Transitions/Using_CSS_transitions) 资料可得 `transition` 的用法为：

```
.transition-target {
  transition: <property> <duration> <timing-function> <delay>;
}

```

我们为立方体加上相应的代码：

```
.cube {
  ...
  // <property> = transform
  // <timing-function> = ease
  // <duration> = 1s
  // <delay> = 0
  transition: transform ease 1s;
  ...
}

```

此时如果我们将立方体 `div` 容器的 `show-default` 类名替换成 `show-left`，就可以看到它左面旋转至我们眼前的 3D 效果啦。

案例最终的效果如下图所示：

![3D transition](https://user-gold-cdn.xitu.io/2018/3/10/1620fe3acf281813?w=950&h=376&f=gif&s=2510549)

### Transition 动画的局限性和适用性

`transition` 实现的动画有下面这些特点：

1.  支持有限的 CSS 属性

可通过[《CSS animated properties》](https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_animated_properties)一文查看支持过渡动效的 CSS 属性。

2.  隐式过渡（implicit transitions）

`transition` 的过渡动画是隐式的（如下图所示，图片来源于 [MDN](https://developer.mozilla.org/zh-CN/docs/Web/CSS/CSS_Transitions/Using_CSS_transitions)），即除了动画的开始状态和结束状态我们可以自定义之外，「状态变换」的具体过程由浏览器自动执行，中途无法进行人为干预。当然，我们还可以为浏览器执行动画时指定动画的具体时长（`duration`），以及时间轴函数（`timing function`）。

![隐式过渡](https://user-gold-cdn.xitu.io/2018/3/12/1621877fdfc0d719?w=706&h=204&f=png&s=18685)

3.  一次性、不可暂停或反转

`transition` 只支持两个状态之间的变换过渡，不支持多个状态的连续变换过渡，并且状态的变换是一次性的（无法循环）， 不可暂停，且不可反转（从状态 A 过渡到 B 后不能立即又过渡回 A）。

所以，在实际应用中我们常常利用 `transition` 来做那些轻量的、修饰性的动效，用于增强用户在网页上操作时得到的反馈。例如：

*   元素「hover」 或「点击」后的反馈
*   弹窗「打开」或「关闭」时的效果
*   ...

### 扩展阅读

1.  通过 Mozilla 的 [MDN](https://developer.mozilla.org/en-US/) 文档来了解 `transition` 的详细说明及使用示例：

*   [《Using CSS transitions》](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_Transitions/Using_CSS_transitions)

2.  结合 CodePen 代码示例了解 `transition` 和 `transform` 的相关属性:

*   [《CSS Transitions and Transforms for Beginners》](https://robots.thoughtbot.com/transitions-and-transforms)

## CSS3 Animation

如果我们想让元素的动效支持多个状态之间的连续过渡变换、支持循环，甚至支持暂停或反转，我们该怎么办？答案就是：`animation` -- 利用 CSS3 让网页元素动起来的第二个方法。

学习 `animation` 动画需首先掌握两个关键的基本知识点：

*   关键帧（`@keyframes`）
*   `animation` 属性

### 关键帧（`@keyframes`）

`@keyframes` 用来定义动画的具体内容，它包括以下内容：

*   动画叫什么名字？
*   动画开始、中间及结束状态有哪些？（可以理解成每个状态对应一个关键帧）
*   每个状态出现在动画过程中的哪个时间点？

我们来瞅一个 `@keyframes` 的实际例子，来源于有名的 `animation` 动画库 [Animate.css](https://daneden.github.io/animate.css/)，其中的「[bounceIn](https://github.com/daneden/animate.css/blob/master/source/bouncing_entrances/bounceIn.css)」动效的关键帧代码如下：

```
@keyframes bounceIn {
  from,
  20%,
  40%,
  60%,
  80%,
  to {
    animation-timing-function: cubic-bezier(0.215, 0.61, 0.355, 1);
  }

  0% {
    opacity: 0;
    transform: scale3d(0.3, 0.3, 0.3);
  }

  20% {
    transform: scale3d(1.1, 1.1, 1.1);
  }

  40% {
    transform: scale3d(0.9, 0.9, 0.9);
  }

  60% {
    opacity: 1;
    transform: scale3d(1.03, 1.03, 1.03);
  }

  80% {
    transform: scale3d(0.97, 0.97, 0.97);
  }

  to {
    opacity: 1;
    transform: scale3d(1, 1, 1);
  }
}

```

显然，这段关键帧的代码做了以下事情：

*   定义了动画的名称为「bounceIn」
*   将动画过程划分成了 6 个状态（6 个关键帧）
*   除了开始和结束这两个时间位置外，另外 4 个关键帧的时间位置分别为：20%、40%、60% 和 80%

### `animation` 属性

细心的读者会发现上面示例中的 `animation-timing-function` 相关代码，其实是 `animation` 属性相关的知识点，除了关键帧之外，谙熟 `animation` 属性（及其“子”属性）的具体含义及用法，也是学习 `animation` 动效的基本要求。

`@keyframes` 用来定义一个动画的具体状态内容，而 `animation` 属性用来定义一个元素执行某个动画时的相关动画设定，包括：

*   指定元素用什么动画？（[animation-name](https://developer.mozilla.org/en-US/docs/Web/CSS/animation-name)）
*   动画的持续时间是多少？（[animation-duration](https://developer.mozilla.org/en-US/docs/Web/CSS/animation-duration)）
*   浏览器用什么样的时间轴函数来执行该动画？（[animation-timing-function](https://developer.mozilla.org/en-US/docs/Web/CSS/animation-timing-function)）
*   是否需要延时执行该动画？([animation-delay](https://developer.mozilla.org/en-US/docs/Web/CSS/animation-delay))
*   动画循环执行的次数是多少？（[animation-iteration-count](https://developer.mozilla.org/en-US/docs/Web/CSS/animation-iteration-count)）
*   动画执行的方向是什么？（[animation-direction](https://developer.mozilla.org/en-US/docs/Web/CSS/animation-direction)）
*   动画填充模式是什么？（[animation-fill-mode](https://developer.mozilla.org/en-US/docs/Web/CSS/animation-fill-mode)）
*   动画执行状态是运行还是暂停？（[animation-play-state](https://developer.mozilla.org/en-US/docs/Web/CSS/animation-play-state)）

对于 `animation` 相关属性的介绍和使用示例，可以在 [MDN](https://developer.mozilla.org/en-US/) 找到十分详尽的资料，这里就不搬运了，读者可以点击括号内的链接进行逐一学习。

值得一提的是，`animation` 动画的延时可以设置为负值（[试试看](https://codepen.io/mamboer/pen/ZxGdpE)），善用负值的 `animation-delay` 有时候可以用最少的代码实现出乎意料的动效。

![负值animation-delay](https://user-gold-cdn.xitu.io/2018/3/12/1621a4bc7d9c9595?w=950&h=350&f=gif&s=575776)

上图的案例（[查看 DEMO](https://codepen.io/mamboer/full/xWGvqj)）来源于[《CSS Animation Tricks: State Jumping, Negative Delays, Animating Origin, and More》](https://css-tricks.com/css-animation-tricks/) 一文，利用负值 `animation-delay` 复用同一个动画轻松实现。相同的效果如果用 GIF 或 `transition` 来实现的话，恐怕会复杂很多。

### 例子 - 让立方体自己转起来

为了更好地体会 `transition` 和 `animation` 两者做动效的异同之处，我们接下来试着利用 `animation` 改写前面 `transition` 做的立方体例子，让它自己转动起来。

#### 步骤 1 - 利用 `@keyframes` 定义转动的动画

定义一个名为「autoRotate」的关键帧动画，并将 `transition` 版本例子中显示立方体每一面的代码搬到 `@keyframes` 中去。 立方体有 6 个面，所以我们把整个动画划分为 6 个关键帧，如下所示：

```
@keyframes autoRotate {
  // show-front
  0%, 100% {
    transform: translateZ( - $cube-radius );
  }
  // show-back
  16.5% {
    transform: translateZ( - $cube-radius ) rotateX( -180deg );
  }
  // show-left
  33% {
    transform: translateZ( - $cube-radius ) rotateY( 90deg );
  }
  // show-right
  49.5% {
    transform: translateZ( - $cube-radius ) rotateY( -90deg );
  }
  // show-top
  66% {
    transform: translateZ( - $cube-radius ) rotateX( -90deg );
  }
  // show-bottom 
  82.5% {
    transform: translateZ( - $cube-radius ) rotateX( 90deg );
  }
}

```

#### 步骤2 - 将 `transition` 属性替换成 `animation` 属性

利用 `animation` 属性，在立方体上应用我们前面定义的「autoRotate」动画，并做以下设定：

*   时间轴函数（`animation-timing-function`）为 `ease`
*   持续时间（`animation-duration`）为 18 秒
*   执行次数（`animation-iteration-count`）为 `infinite`，即无限次
*   执行方向（`animation-direction`）为 `alternate`，即正、反向交替执行

```
// transition: transform ease 1s;
animation: autoRotate ease 18s alternate infinite;

```

以上两个简单的步骤完成了 `animation` 替代 `transition` 实现更丰富的动效，读者可以通过 [查看完整示例代码](https://codepen.io/mamboer/pen/bvVbxv) 并修改 `animation` 属性的其他设定（如 `animation-play-state` 等）来加深体会。

### 扩展阅读

1.  结合 CodePen 案例学习 `animation` 的每一个属性：[CSS Animation for Beginners](https://robots.thoughtbot.com/css-animation-for-beginners)
2.  学习 `animation` 动画的小奇巧：[CSS Animation Tricks: State Jumping, Negative Delays, Animating Origin, and More](https://css-tricks.com/css-animation-tricks/)

## 小结

动效开发以「动」为始，本小节结合示例介绍了利用 CSS3 让网页元素动起来的两种方法——`transition` 和 `animation`，通过对比和结合来加深读者对这两种方法制作动效的理解与体会。

# 六、动效开发 2：聊一聊 3D

我们在前一小节的案例中制作了一个立方体，其实就已经接触到了 3D。

所有东西一跟 3D 扯上关系，复杂指数都是噌噌噌往上走。不过也正常，毕竟多了一个维度，要有三维应有的尊严。

3D Transforms 要怎么写？能写翻牌效果吗？能写翻书效果吗？能写出立体书的效果吗？往下看，答案都在这里面。

很多时候，仅仅将元素进行二维层面的变换显然不是人类的终点，毕竟十二维空间都可能不是极限（视频: [从一维空间到十二维空间](http://v.youku.com/v_show/id_XNjA0MjU5NzA4.html?from=s1.8-1-1.2)）。

[Intro to 3D Transforms](https://desandro.github.io/3dtransforms/) 的作者 David DeSandro 说，现在可是 21 世纪，可我们竟然还在跟三十年前的二维空间界面扯皮。所幸 2011 年，我们有了 CSS3，我们还有了 3D Transforms，真是一个值得奔走相告的大事件。

3D 变换相较 2D 变换，坐标系中多了 Z 轴，也就意味着物体除了上下左右，还可以前后移动。而 rotate 在 2D 中的旋转方式，在 3D 中与 rotateZ 相当。

那么，单纯地将 `transform` 中的参数扩展出 Z 维度，就能实现 3D 效果了吗？我看见 CSS3 笑了。

## `perspective` 概念理解

什么是 `perspective` ？词典中翻译为观点、远景、透视图。这是一个非常抽象的概念，需要一点空间想象力。

我们先抛开这个概念，尝试使用刚才说到的知识点进行翻牌（咦）效果的尝试，聪明的你一定分分钟码出来：

```
<div class="card">
  <!-- 卡牌正面 -->
  <figure class="card-front">1</figure>
  <!-- 卡牌反面 -->
  <figure class="card-back">2</figure>
</div>

```

```
.card-front {
  background: red;
}
.card-back {
  background: blue;
  transform: rotateY( 180deg );
}
/* 翻牌动作 */
.card.flipped {
  transform: rotateY( 180deg );
}

```

但是放浏览器里一看，这不对呀，为什么用 3D 的代码写出了 2D 的效果？

![示例图片](https://user-gold-cdn.xitu.io/2018/2/22/161be021b5fca407)

这个时候有请我们的 `perspective` 透视君。

学过素描的人一定对透视的概念不陌生，透视是保证素描写生真实合理的基础。

> 视频：[透视学之一点透视法](https://www.bilibili.com/video/av14392523/)

CSS3 中的 `perspective` 在这样一个体系里就代表着元素与观者之间的距离，形象点说，就是元素 3D 效果的强度。CSS3 中的 3D 效果消失点固定，变化的是观者与元素之间的距离。不过 `perspective` 数值与 3D 效果强度是成反比的，数值越大，元素的 3D 效果越不明显 —— 2000px 的视点意味着你看的是远方的物体，而 100px 则意味着这个物体就在你眼前。

这里有幅图或许能帮助我们想象 3D 效果强度这个概念。

![3D效果](https://user-gold-cdn.xitu.io/2018/2/22/161be0368bf94a1a?w=750&h=296&f=png&s=13189)

（图片来源：[维基百科](https://en.wikipedia.org/wiki/Perspective_%28graphical%29)）

如果还是不懂，还有一个办法，就是在浏览器中边调整 `perspective` 数值边观察 3D 效果。

![3D效果](https://user-gold-cdn.xitu.io/2018/2/22/161be041596ded52?w=375&h=250&f=gif&s=141903)

## 消失点

![消失点](https://user-gold-cdn.xitu.io/2018/2/22/161be04955ddd5e2)

（图片来源：[Intro to CSS 3D transforms - Perspective](https://desandro.github.io/3dtransforms/docs/perspective.html)）

左图与右图的元素均绕 Y 轴旋转了 45°，但差别很明显，右图更容易让人想到一个画面中集体开启的窗户。左图的问题就在于，每个元素的消失点各自为政，都在元素的中心点位置，而右图的消失点则统一在实线方框的中心位置。实现方法就是将元素的 `perspective` 设置转移至元素父容器上。

明眼人会说，这样子可以画个正方体出来了耶。我看见 CSS3 又笑了。

## 建立三维空间体系

![三维空间体系](https://user-gold-cdn.xitu.io/2018/2/22/161be073a53fcfca?w=750&h=440&f=png&s=55534)

现实总是乳齿残酷~

有了 `perspective` 属性，我们顶多是一群会在纸上画素描的家伙，要想徒手造模型，还是太嫩。就拿刚才的翻牌效果来说，如果你翻滚 `card` 父容器，无论怎么翻，能看到的只有正面的卡片，因为现在的体系就是一张素描绘画，你拿着再逼真的素描画翻到背面，也是看不到真实物体的背面的对吧。超越平面 3D 的关隘就在于 `transform-style: preserve-3d` 的属性设置，默认值为 `flat`，即“素描作品”。这个属性的设置旨在告诉子元素需要遵循怎样的空间体系规则。这个属性不能继承，因此只要有子元素需要设置空间体系规则，就得在父元素声明这个属性。

有了浏览器为我们处理空间体系规则，可以省不少事，不需要你担心层级问题，不需要你操心哪个元素转到哪里要消失，哪个元素转到哪里要出现。嗯，笔者从没自己这么干过，从没。

## 从翻牌到翻书

翻牌那是皇帝干的事儿，我们文化人得翻书。刚才的翻牌都是在方块的中部为轴进行的变换，我们把变换原点 `transform-origin` 一换，就变成书页在翻了。

一本合上的书正常来说是在 Y 轴右侧，每一页都包含两面，也就是说一本书是由若干个翻页效果组合而成，每一页的变换原点在元素左侧。由此可以在翻牌的基础上迅速整出一个翻书 DEMO（猛戳 [查看翻书 DEMO](http://lyxuncle.github.io/pageturning/demo/demo.html)）。

阴影的使用能让翻书效果变得更真实。

![翻书demo](https://user-gold-cdn.xitu.io/2018/2/22/161be0897748f7f1?w=750&h=474&f=png&s=9157)

（猛戳 [查看 DEMO（带阴影）](http://lyxuncle.github.io/pageturning/demo/demo2.html)）

## 3D 动画之 Hard Level：立体书

立体书在外国叫 Pop-Up Book，满满的 “Surprise!” 感。这种超越传统平面书籍的阅读模式常被用于儿童书籍。

![立体书](https://user-gold-cdn.xitu.io/2018/2/22/161be095c5d6b89c?w=750&h=343&f=png&s=105713)

（图片来源：[A Guided Tour of THE MEL BIRNKRANT COLLECTION](http://melbirnkrant.com/collection/page48.html)）

要用 CSS3 实现这种效果，想想还有点小激动。

首先建立一个立体书规则：

*   书开，元素起
*   元素竖起速度小于等于书页开启速度
*   元素折叠后不可露出书边
*   元素层叠关系不可反自然

剩下的事也就水到渠成，无非是在每一页建立 3D 体系、立体元素从 `rotateY(90deg)` 转换到 `rotateY(0deg)` 的事儿。

![Mozzilla的小demo](https://user-gold-cdn.xitu.io/2018/2/22/161be0b6c5cee676?w=375&h=254&f=gif&s=491562)

（[Mozzilla 的小 DEMO](http://www.html5tricks.com/demo/css3-3d-book/index.html)）

笔者曾做过一个丧心病狂的立体书触屏页，由于立体书左右两页互相关联的特性，翻牌的方式不太适合用在这里，这里使用的是另一种较为麻烦的方式 —— 不像翻牌方式中的前后两页捆绑，这里的书页左右两页属于一个 3D 体系，通过 `translateZ` 值的变换控制层级关系，因为在 3D 体系里，`z-index` 已被抛弃。

猛戳进入 [麦芒推广页](http://jdc.jd.com/fd/pp/maimang/index.html) 体验 3D 立体书效果。

## 终端支持

由于截至目前为止，CSS3 的 3D 功能还止于炫技的阶段，安卓机与 iOS 的支持效果存在差异且难以调和，从上面那个案例中肉眼可见的坑就能看出，因此除了简单的 3D 转换，不建议在生产项目中大面积使用 3D 深层功能。

![买家秀](https://user-gold-cdn.xitu.io/2018/2/22/161be0c7c0d7c03d?w=750&h=320&f=png&s=30011)

## 3D 与硬件加速

坊间流传这这样一个传说：一旦使用 3D 属性，就能触发设备的硬件加速，从而使得浏览器的表现更佳。但这句话也得看情境——

> 想象使用 GPU 加速的动画就像是 Vin Diesel（速度与激情的主角）开着 Dominic 标志性的汽车 —— Dodge Charger。它的定制 900 hp 引擎可以让它在一瞬间从 0 加速到 60 码。但是如果你开着它在拥挤的高速公路上又有什么用呢？这种情况下错的不是你的车辆，而是你还在一条拥堵的高速公路上。—— [《CSS 硬件加速的好与坏》](http://efe.baidu.com/blog/hardware-accelerated-css-the-nice-vs-the-naughty/)

因此千万别贪心，将 3D 效果数量控制在一定范围内，页面性能才是重中之重。——来自得到惨痛教训的笔者的忠告。

## 扩展阅读

*   [Intro to CSS3 3D transforms](https://desandro.github.io/3dtransforms/) by David DeSandro —— 详尽又新鲜的 3D Transformers 手册，包含许多一看就懂的小 Demo，妈妈再也不用担心我的 3D 了。
*   [Perspective (graphical)](https://en.wikipedia.org/wiki/Perspective_%28graphical%29) —— 对透视学还一知半解的可以看看维基的详细说明。
*   [Unfolding the Box Model: Exploring CSS 3D Transforms](http://rupl.github.io/unfold/) by Chris Ruppel —— 非常赞的 3D Transforms 介绍，从 2D 到 3D 过渡，启动联想学习法，一看就明白，就怕你不看。
*   [CSS 硬件加速的好与坏](http://efe.baidu.com/blog/hardware-accelerated-css-the-nice-vs-the-naughty/) —— 很多事情都不是一两句能讲清楚的，但是只要深入了解原理，一两句都不用讲就清楚了。

## 小结

本小节结合案例为大家介绍了实现 3D 效果的几个关键点：透视的概念理解—— `perspective`、空间变换体系 —— `transform-style`、Z 轴位移 —— `translateZ`。读者可以通过我们提供的丰富案例进一步体会 3D 效果的具体实现。

# 七、动效开发 3：补间动画

我们已经知道如何利用 CSS3 让网页元素动起来，也知道怎么样让它变得立体，接下来为大家讲解在实际工作过程中最为常见的两种基础动画形式 ——「补间动画」和「逐帧动画」，先从「补间动画」说起。

> 「补间动画」（Tween Animation）指的是：人为设定动画的关键状态（也就是关键帧），而关键帧之间的过渡过程则由计算机处理渲染的动画处理形式。

回想一下前面两个小节中的各种案例，不难发现 `transition` 属性实现的动画都属于补间动画，而对于 `animation` 属性来说，使用了除 `steps` 和 `frames` 以外的时间函数（如 `ease`、`linear` 或 `cubic-bezier` 等）的动画都属于补间动画。

可以说补间动画是 CSS3 动画中最常见的一种形式，常见到平时工作中几乎所有的动效需求案例都能找到它的影子。

## 案例实战 1 - 京东 2017 海外招聘 H5

我们以京东 [2017 海外招聘](http://jdc.jd.com/h5/jd-campus-2017/international/index.html) H5 的第三屏动画为例，为大家讲解如何利用 CSS3 实现补间动画。

![2017 京东海外招聘](https://user-gold-cdn.xitu.io/2018/3/5/161f5e3f6c354820?w=640&h=503&f=gif&s=133040)

### 步骤 1 - 动效审查与分解

动效审查与分解是动效开发的首要步骤，不管我们开发的是「补间动画」还是「逐帧动画」。根据提供的设计稿，和设计师一起围绕动效进行沟通审查（事实上有经验的设计师会在开始视觉设计之前提前和开发同学沟通动效，设计稿定稿之后再一起回顾沟通），了解设计师对动画时序的想法，并根据自己的开发经验评估预期动效设计的合理性，必要的时候给予设计稿调优建议。

动效审查完毕后，可以输出一张动画属性分解表，以便于后续开发的时候进行追溯调优，如下图所示。

![动画属性分解表](https://user-gold-cdn.xitu.io/2018/3/14/16220a66bc168cba?w=1568&h=486&f=jpeg&s=72932)

### 步骤 2 - 根据需求进行切图

根据动画属性分解表，先进行切图（可回顾小册的第 2 小节），将需要添加动效的元素单独切出，如下图所示。

![切图](https://user-gold-cdn.xitu.io/2018/3/14/16224c101bc173f4?w=960&h=231&f=jpeg&s=16390)

### 步骤 3 - 页面编码开发

切图完成后，我们根据设计稿进行构建还原，编写对应的页面 HTML 结构和样式。

具体的 HTML 代码和 SCSS 样式如下所示。

```
<!-- S 宣讲行程时间轴 -->
<div class="timeline">
  <div class="timeline_tit">
    宣讲行程
    <span>Campus Talk Schedule</span>
  </div>
  <div class="timeline_icon">
    <svg viewBox="0 0 102 102">
    <circle cx="51" cy="51" r="50" transform="rotate(90 51 51)"></circle>
  </svg>
  </div>
  <ul class="timeline_list">
    <li class="timeline_item timeline_item_sp">
      <span class="timeline_item_cnt flag"><i class="flag_sin"></i></span>
      <span class="timeline_item_cnt country"></span>
      <b></b>
    </li>
    <li class="timeline_item">
      <span class="timeline_item_cnt time">09 / 20</span>
      <span class="timeline_item_cnt city">INSEAD</span>
      <b></b>
    </li>
    <li class="timeline_item">
      <span class="timeline_item_cnt time">09 / 21</span>
      <span class="timeline_item_cnt city">NTU</span>
      <b></b>
    </li>
    <li class="timeline_item timeline_item_sp">
      <span class="timeline_item_cnt flag"><i class="flag_us"></i></span>
      <span class="timeline_item_cnt country">U.S</span>
      <b></b>
    </li>
    <li class="timeline_item">
      <span class="timeline_item_cnt time">09 / 26</span>
      <span class="timeline_item_cnt city">UCLA</span>
      <b></b>
    </li>
    <li class="timeline_item">
      <span class="timeline_item_cnt time">09 / 28</span>
      <span class="timeline_item_cnt city">UC Berkely</span>
      <b></b>
    </li>
    <li class="timeline_item">
      <span class="timeline_item_cnt time">10 / 05</span>
      <span class="timeline_item_cnt city">Wharton</span>
      <b></b>
    </li>
    <li class="timeline_item timeline_item_sp">
      <span class="timeline_item_cnt flag"><i class="flag_uk"></i></span>
      <span class="timeline_item_cnt country">U.K</span>
      <b></b>
    </li>
    <li class="timeline_item">
      <span class="timeline_item_cnt time">10 / 29</span>
      <span class="timeline_item_cnt city">LBS</span>
      <b></b>
    </li>
    <li class="timeline_line"></li>
  </ul>
</div>
<!-- E 宣讲行程时间轴 -->

```

```
.timeline {
  position: absolute;
  width: 100%;
  height: 100%;
  left: 0;
  top: 0;
  &_tit {
    position: relative;
    padding: rem(70px) 0 rem(30px);
    font-size: rem(60px);
    line-height: rem(90px);
    color: #fff;
    text-align: center;
    span{
      display: block;
      font-size: rem(36px);
      line-height: rem(50px);
    }
    &:after{
      content: "";
      position: absolute;
      width: rem(92px);
      height: 1px;
      background: #ff0000;
      bottom: 0;
      left: 50%;
      margin-left: rem(-46px);
    };
  }
  &_icon {
    position: relative;
    width: rem(102px);
    height: rem(102px);
    margin: rem(36px) auto 0;
    background: url("images/p3_01.png?__inline") no-repeat center;
    background-size: rem(57px) rem(50px);
    svg {
      width: rem(102px);
      height: rem(102px);
      stroke: #0084ff;
      stroke-width: 2px;
      fill: none;
      stroke-dasharray: 400;
    }
  }
  &_list {
    position: relative;
    bottom: 0;
    width: rem(900px);
    height: rem(1224px);
    margin: 0 auto;
    padding: rem(68px) 0;
    display: flex;
    flex-direction: column;
    color: #fff;
  }
  &_line {
    position: absolute;
    width: 1px;
    height: 100%;
    background: #0084ff;
    top: 0;
    left: 50%;
  }
  &_item {
    position: relative;
    flex: 1;
    display: flex;
    align-items: center;
    z-index: 9;
    b {
      position: absolute;
      width: rem(16px);
      height: rem(16px);
      border-radius: 50%;
      left: 50%;
      top: 50%;
      margin: rem(-7px) 0 0 rem(-7px);
      z-index: 1;
      background: #fff;
      box-shadow: 0 0 0 rem(13px) #0084ff;
    }
    &_sp {
      b{
        background: #0084ff;
        box-shadow: none;
      }
    }
    &_cnt {
      flex: 1;
      padding: 0 rem(100px);
      &:nth-child(1){
        text-align:right;
      };
      &:nth-child(2){
        text-align:left;
      };
      &.flag{
        width: rem(111px);
        height: rem(65px);
        i{
          display: inline-block;
          width: rem(111px);
          height: rem(65px);
          background-size: 100%;
        }
      }
      &.country{
        font-size: rem(36px);
        color: #66b5ff;
      }
      &.time{
        font-size: rem(36px);
      }
      &.city{
        font-size: rem(48px);
      }
      .flag_sin{
        background: url("images/p3_02.png?__inline") no-repeat;
      }
      .flag_us{
        background: url("images/p3_03.png?__inline") no-repeat;
      }
      .flag_uk{
        background: url("images/p3_04.png?__inline") no-repeat;
      }
    }
  }
}

```

### 步骤 4 - 结合动画属性分解表实现动画

我们从步骤 1 获得了动画属性分解表，下面根据它来一一实现动画。

#### 1\. 图标圆形边框的路径描边动画

这样的描边动画效果无法用 CSS3 的方案实现，但可以通过 SVG 的方案来实现。

##### 1.1 确保 SVG 图形设置 `stroke` 属性实现描边效果

```
svg {
  // 设置描边 
  stroke: #0084ff;
  stroke-width: 2px;
  fill: none;
}

```

##### 1.2 对 SVG 图形设置 `stroke-dasharray` 属性

`stroke-dasharray` 属性是用来设置描边的虚线的图案范式，也就是设置实线段和虚线段的宽度。

我们对 `stroke-dasharray` 属性作如下设置，其含义就是，实线段的长度为 320，而虚线段的长度为 0，所以我们看到的仍是一条实线的描边。

```
stroke-dasharray: 320; // stroke-dasharray: 320 0; 的等价写法

```

接下来我们利用 `stroke-dashoffset` 属性使得这条实线描边可以出现和消失。

##### 1.3 利用 `stroke-dashoffset` 属性实现补间动画

`stroke-dashoffset` 属性指定了虚线路径起始点的距离。

因此，当我们把 `stroke-dashoffset` 的值设置为 circle 的路径总长度时，描边轨迹就会完全不可见，而逐步减小其值至 0 时，可使之完全呈现。

我们可以通过脚本获取描边路径的总长度：

```
// 我们取整为320
var path = document.querySelector('circle').getTotalLength(); // 等于313.6517333984375

```

最后，我们只需要设置初始关键帧和结束关键帧，对 `stroke-dashoffset` 属性值从 320 变为 0 ，再根据动画时间表里的动画时间、延时以及时间函数进行动画属性设置，就实现了 SVG 路径描边的补间动画，代码如下所示。

```
.part3.in {
  .timeline_icon {
    svg {
      animation: on_tl_iconsvg .5s 0.9s linear both;
    }
  }
}

@keyframes on_tl_iconsvg{
  0% {stroke-dashoffset: 320;}
  100% {stroke-dashoffset: 0;}
}

```

对于 `animation-fill-mode` 属性的详解，笔者推荐[《理解 animation-fill-mode 属性》](https://www.w3cplus.com/css3/understanding-css-animation-fill-mode-property.html)一文，这里不作赘述。

#### 2\. 图标的渐现和上移动画

图标的渐现和上移效果都是作用于图标而言的，因此我们把这两个动画合在一起写。

对于渐现渐隐效果，为了获得更好的性能，我们使用 `opacity` 属性，而不是 `display`、`visibility` 属性；出于同样的考虑，对于偏移效果，则使用 `translate` 属性，而避免使用 `left`、`right`、`bottom`、`top` 属性。

选取好合适的 CSS 属性之后，我们最后根据动画分解表进行分析实现。从表中可知，渐变效果的时间为 0.8s，占总时间 1.2s 的比率为 66.66%，再配合从设计稿测量得到的偏移值 480px，最终我们很快就写出了动画代码，如下所示：

```
.part3.in {
  .timeline_icon {
    animation: on_tl_icon 1.2s .5s linear both;
  }
}

@keyframes on_tl_icon{
  0% {transform: translateY(rem(480px));opacity: 0}
  // 先渐现
  66.66% {transform: translateY(rem(480px));opacity: 1}
  // 再向上偏移
  100% {transform: translateY(0);opacity: 1}
}

```

标题、标题下划线、日程时间轴线的动画实现，也是类似图标渐现和上移动画的做法，这里就不展开了。

下面，我们来详细讲讲如何实现「日程时间轴的列表项按次序出现」的补间动画。

#### 3\. 日程时间轴的序列动画

日程时间轴的列表项按次序出现的补间动画，这种对多个元素使用相同的动画效果，且各个元素动画执行时机依次错开的、整齐有序的序列动画效果，我们可称之为序列动画。

首先，我们实现列表项展开的动画效果，代码如下所示。

```
@keyframes on_tl_item {
  0% {transform: scale(0,0); opacity: 0}
  100% {transform: scale(1,1); opacity: 1}
}

```

接着，我们利用 `animation-delay` 属性进行延时控制动画执行时机的依次错开。

根据动画分解表，我们知道动画时长为 0.45s，初始延时 2.35s，而每个列表项之间间隔 0.15s，因此推算得出第 i 个列表项（1 <= i < 10）的延时为（2.2s + 0.15s + i )。

配合 SCSS 的 `@for` 控制指令用法，我们可以快速地循环输出样式，代码如下所示。

```
.part3.in {
  .timeline_item {
    animation: on_tl_item 0.45s ease both;
    @for $i from 1 to 10 {
      &:nth-child(#{$i}) {
        animation-delay: (2.2s + 0.15s * $i);
      }
    }
  }
}

```

利用 `@for` 控制指令为多个列表项元素的相同动画效果动态生成样式，并且通过 `animation-delay` 来控制依次错开动画执行的时机，从而形成整齐有序的序列动画效果。

至此，整个第三屏动画就完成了，查看 [完整的 DEMO](http://jdc.jd.com/demo/ting/H5Demo/recruit/index.html) 进行体验。

## 案例实战 2 - 京东 App 搜彩蛋：把动效设计的锅扔给设计师

我们知道，动效开发的流程往往是：

1.  设计师和开发童鞋一起构思整个动画的方案
2.  设计师根据动画方案出设计稿
3.  开发童鞋根据设计稿及动画方案自由发挥，进行动效的设计与开发

在这样的流程下，动画成品效果的好与坏往往取决于开发童鞋在动效设计方面的知识和经验是否丰富，而这对于初次接触动效开发的童鞋来说恐怕是极大的挑战。

事实上，大多数前端开发者在动效设计方面并没有太多的积累，难以做出令人拍手称赞的动画效果。而设计师（或动效设计师）却刚好相反，因为他们一般都擅长使用做动效设计的工具 —— Flash 或 AE（After Effects）。

> 把「动效的设计」交给更专业的设计师，让他们输出完整的「动效稿」，再让开发童鞋依据「动效稿」转换成为网页代码，未尝不是一种好的动效开发方式。（笔者注：腾讯 TGideas 团队早在两三年前就开始探索和实践这种动效开发方式，积累了丰富的实战经验。）

由设计师来负责动效的设计，对项目来说还有以下好处：

*   设计师与开发的排期由「线性」变为「部分重叠」：设计师交付静态设计稿后，开发就能进行视觉还原构建页面，设计师此时即可进入动效设计。
*   设计师将动效设计导出为视频，提前取得各方满意度，避免开发期间的反复沟通修改。

对开发童鞋来说，我们会迎来一个新的问题：如何还原「动效稿」，将它转换成保真的网页动效？

我们接下来以「京东 2017 年 App 搜彩蛋项目 —— 苹果彩蛋」为例，为大家解读如何基于 AE 稿开发补间动画（其思路也适用于逐帧动画）。

![苹果彩蛋](https://user-gold-cdn.xitu.io/2018/3/12/162190a52c3f1f42?w=300&h=534&f=gif&s=858674)

_读者可以自行 [下载本案例所用的 AE 稿](http://jdc.jd.com/lab/2018-ae2css/apple.zip)。_

### 基于 AE 实现 Web 动效

基于 AE 手工实现 Web 动画的主要工作有两个：

1.  取参 —— 在动效稿上拿到元素的参数信息，如 x/y/z、rotation、动画设定等
2.  开发 —— 通过适当的 Web 技术进行动画开发，如 CSS3/Canvas/SVG 等

#### 取参及 AE 界面使用指引

打开 apple.aep 文件，AE 界面如下：

![apple.aep](https://user-gold-cdn.xitu.io/2018/3/12/162190a535df07f3?w=1233&h=1091&f=png&s=79259)

_点击 「信息模块」预览面板的播放按钮或拖动「时间轴模块」的 标记3 即可预览动画。_

为了利用 CSS3 `animation` 属性实现最终的动效，我们需要获取以下关键设置信息：

*   动画持续时间 `animation-duration`
*   关键帧之间的时间轴函数 `animation-timing-function`
*   动画延时时间 `animation-delay`

> 由于该动画是一次性的，无需设置/获取动画的重复次数（animation-iteration-count）及执行方向（animation-direction）。

我们选取整个苹果彩蛋动画中一个小圆圈（共 60 个）为示例代表，其余元素同理。

现在我们把目光投向「图层、运动模块」的 标记1：

![标记1](https://user-gold-cdn.xitu.io/2018/3/12/162190a540833ad1?w=539&h=182&f=png&s=6554)

_（标记1 —— FPS）_

由上图可得，FPS 为 12，即 1 秒 12 帧， 1 帧 0.0833 秒。

通过观察苹果彩蛋动画的预览效果可以发现，每个圆的延时时间（`animation-delay`）、时间轴函数（`animation-timing-function`）和持续时间（`animation-duration`）均不相同。换句话说，每个圈都是一个独立的补间动画，所有元素组合起来才是一个完整的补间动画。

双击「标记 2」，进入编组以查看每个圆的信息。

![每个圆的信息](https://user-gold-cdn.xitu.io/2018/3/12/162190a55546ad8c?w=1233&h=1091&f=png&s=55136)

_（子元素——圆）_

在「查看器」或「图层、运动模块」任意选中一个圆，展开其 **变换** 属性并单击 **位置**（标记1），即可显示右侧的元素运动路径（标记2）。同时这也反映了动画的变化速率（即时间轴函数 animation-timing-function），后面会做进一步解读。

值得注意的是：**位置** 前面的时钟图标为蓝色时，代表当前属性有过渡动画。

![某个圆的时间轴](https://user-gold-cdn.xitu.io/2018/3/12/162190a563aeee18?w=1185&h=626&f=png&s=30774)

_（某个圆的时间轴）_

综上所述，可从上图得出以下信息点：

1.  该元素共有 4 个关键帧（绿线上的小方块）
2.  只有 Y 轴上发生位移运动（绿线），X 轴上则是静止状态（红线）
3.  延时时间为 1 帧（绿线前面的虚线处）
4.  中间停留时间（第2、3 关键帧之间）为 1 帧
5.  过渡时间为 42 帧（3\*12 + 7 - 1）。注意要减去延时时间（1），因为 02:03 包含了它

#### 利用 `animation` 属性实现动画

在拿到动画所需的各项设定参数信息后，便可以利用我们熟悉的 `animation` 实现某个圆的补间动画了。

```
<div class="circle-29"></div>

```

```
/* 默认定位在第2（或3）帧以让元素默认显示在屏幕内，便于开发调试。 */
.circle-29 {
    width: 60px;
    height: 60px;
    background-color: rgba(0, 224, 93, .7);
    position: absolute;
    left: 473px;
    top: 348px;
    border-radius: 50%;
    animation-name: circle29;
    animation-duration: 3.5s; /* 42 * (1 / 12) */
    animation-delay: 0.0833s; /* 1 * (1 / 12) */
    animation-fill-mode: both;
    animation-timing-function: ease-in-out;
}
@keyframes circle29 {
    0% {
        transform: translate3d(0, 1175px, 0);
    }
    61.90% { /* (2 * 12 + 3 - 1) / 42，注意要减去延时时间（1），因为 02:03 包含了它。下同。*/
        transform: translate3d(0, 0, 0);
    }
    64.29% {
        transform: translate3d(0, 0, 0);
    }
    100% {
        transform: translate3d(0, -1225px, 0);
    }
}

```

虽然略微烦琐，但是省去反复调整动画设定的时间，基本做到一次开发即可输出满意的效果。

其余元素参考以上步骤执行即可完成整个苹果彩蛋动画。

假设没有动画预览效果和动效稿，仅靠开发童鞋自由发挥编码完成一个由 60 多个元素组成的动画，简直难于上青天（至少对于笔者来说）。

#### 效果演示

上述实现代码使用 CodePen 做演示，读者可以自行查看体验。

*   [查看单个圆的补间动画](https://codepen.io/JChehe/full/VQOxxX)
*   [完整的苹果彩蛋动画](https://codepen.io/JChehe/full/ddBZKY)

或扫码体验：

![苹果彩蛋动画](https://user-gold-cdn.xitu.io/2018/3/12/162190a5ef8ca0b9?w=280&h=280&f=png&s=649)

_（基于 AE 稿实现的补间动画 —— 2017 年京东 App 搜索彩蛋 ）_

## 小结

本小节以 2 个实际工作中的案例 —— [「2017 京东海外招聘 H5」](http://jdc.jd.com/h5/jd-campus-2017/international/index.html) 及 [「2017 年京东 App 搜索彩蛋」](http://jdc.jd.com/lab/2018-ae2css/apple/)，分别为大家讲解了「如何利用 CSS3 实现补间动画」及「基于 AE 稿实现补间动画」的完整过程。在实际工作过程中，如果动画方案较为复杂，可以尝试后者，让设计师使用 AE 设计完整的动画，开发的时候基于 AE 稿来还原动效。当然，无论是哪一种方式，目前看来都免不了较大的人肉开发成本，虽然业界出现了一些能够直接将 AE 动画导出为 Web 动画的插件或开源库（代表性的有 [Bodymovin](https://www.adobeexchange.com/creativecloud.details.12557.html) 和 [lottie-web](https://github.com/airbnb/lottie-web)，笔者还尝试使用 Bodymovin 实现了前面的苹果彩蛋动画，[查看 DEMO](http://jdc.jd.com/lab/2018-ae-apple/)），但其实际可用性还有待进一步的验证。

# 八、动效开发 4：逐帧动画

前一小节我们花了很大的篇幅去讲解「补间动画」的开发，除了因为它最常见，还因为其中间的许多实现思路（如「动效的审查与分解」、「基于 AE 动效稿还原动画」）同样适用于本小节将要介绍的另一种常见的基础动画形式 —— 「逐帧动画」。

## 什么是逐帧动画

逐帧动画的英文名字是 Frame-By-Frame Animation，其在维基百科中有如下定义：

> 定格动画，又名逐帧动画，是一种动画技术，其原理即将每帧不同的图像连续播放，从而产生动画效果。

简而言之，逐帧动画有两个要素：

（1）相关联的不同图像，即动画帧  
（2）连续播放

逐帧动画最经典的例子，莫过于手翻书了。动画帧绘制在书本的不同页上，通过手动翻页来实现连续播放：

![逐帧动画](https://user-gold-cdn.xitu.io/2018/2/22/161bde4366d4d605?w=480&h=270&f=gif&s=7498666)

![逐帧动画](https://user-gold-cdn.xitu.io/2018/2/22/161bde4c9494ca83?w=500&h=281&f=gif&s=943006)

_（图片来源：[《一起翻一翻，手翻书的前世今生》](http://blog.sina.com.cn/s/blog_67157b2a0102vcx3.html)）_

## 逐帧动画的前端实现方案

在细聊 CSS3 逐帧动画之前，我们先了解下前端实现逐帧动画的几种方案。

### 1\. 直接使用 GIF

GIF 可以有多个动画帧，连续播放是其自身属性，是否循环也是由其本身决定的。

GIF 往往用来实现小细节动画，成本较低、使用方便、兼容性好，但同时也存在画质低、交互不灵活等问题。

### 2\. 使用 JavaScript 控制动画播放

将动画帧合并成雪碧图，放到 `background-image` 中，通过 JavaScript 改变 `background-position` 的值来实现动画的播放。

使用 JavaScript 实现逐帧动画，兼容性佳，且交互灵活。

### 3\. 使用 Canvas 及相关库

将动画帧绘制到 Canvas 上，通过不断地重绘即可实现逐帧动画。[CreateJS](https://www.createjs.com/)、[Pixi.js](http://pixijs.com) 等库都提供了成熟的方案。

使用 Canvas 可以利用硬件加速，功能强大，操作灵活，有丰富的类库，但学习成本较高，且老式浏览器不兼容 Canvas。

### 4\. 使用 CSS3 阶梯函数 `steps(number_of_steps, direction)`

CSS3 使用 `animation-timing-function` 的阶梯函数 `steps(number_of_steps, direction)` 来实现逐帧动画。

> 在实际工作过程中，开发「逐帧动画」最为常见的两种方式是第 3 和 4 种，CSS3 Animation 兼容性良好，相对于 JavaScript，CSS3 逐帧动画使用简单，且开发效率更高；而 Canvas 因为其性能优势，帧与帧之间切换的衔接度更高，适合实现帧数或尺寸（宽高）较大的逐帧动画。

## 案例实战 1 - 利用 CSS3 实现逐帧动画

与使用 JavaScript 实现相同，通过 CSS3 实现逐帧动画时，也是将动画帧放到 `background-image` 中。

逐帧动画往往有多个不同的动画帧，可以直接通过更改 `background-image` 的值实现帧的切换，但多个图片文件会带来多个 HTTP 请求，且不利于文件的管理。

比较妥当的做法是，将所有的动画帧合并成一张雪碧图（sprite），通过改变 `background-position` 的值来实现动画帧切换。因此，逐帧动画也被称为“精灵动画（sprite animation）”。

下面以京东到家的触屏页面[《年货送到家》](http://jdc.jd.com/fd/promote/201601/djnianhuo/)中的一个场景为例，为大家讲解如何利用 CSS3 来实现逐帧动画。

![最终效果](https://user-gold-cdn.xitu.io/2018/2/22/161bdf0064d07c2b?w=260&h=254&f=gif&s=16600)

### 步骤 1 - 将动画帧合并为雪碧图

动画帧的合并方法有很多，可以使用图片处理软件、在线雪碧图工具、自动化脚本等。这里将介绍 Photoshop 中的操作。

1.  准备好需要合并的动画帧，这里使用的动画帧尺寸为 200 x 206

![动画帧](https://user-gold-cdn.xitu.io/2018/2/22/161bde8f28c95485?w=575&h=360&f=png&s=83213)

2.  打开 Photoshop - 文件 - 自动 - 联系表 II，选取所有动画帧，设置文档尺寸，注意红框部分取消勾选

![动画帧](https://user-gold-cdn.xitu.io/2018/2/22/161bdea096ca7b71?w=696&h=787&f=png&s=128002)

3.  背景图层不可见，导出雪碧图并命名为 p8.png

![动画帧](https://user-gold-cdn.xitu.io/2018/2/22/161bdeab78d69a82?w=292&h=378&f=png&s=26077)

![动画帧](https://user-gold-cdn.xitu.io/2018/2/22/161bdeb499e492c3?w=1096&h=852&f=png&s=209765)

此时，我们可以得到如下的雪碧图 p8.png：

![雪碧图](https://user-gold-cdn.xitu.io/2018/2/22/161bdebc05d489f4?w=465&h=525&f=png&s=75943)

### 步骤 2 - 元素定位并设置背景

元素的尺寸需与动画帧的尺寸相同/等比例，将雪碧图放到元素的 `background-image` 中：

```
.page_key {
  position: absolute;
  left: 20px;
  top: 20px;
  width: 200px;
  height: 206px;
  background-image: url("../img/p8.png");
}

```

### 步骤 3 - 使用 `steps` 实现动画播放

通过查看 W3C 文档，可知 `steps(number_of_steps, direction)` 指定了一个阶梯函数，包含两个参数：

*   第一个参数指定了函数中的间隔数量（必须是正整数）
*   第二个参数可选，指定在每个间隔的起点或是终点发生阶跃变化，接受 `start` 和 `end` 两个值，默认为 `end`

可以通过下图更深入地理解 `steps` 函数：

![steps函数](https://user-gold-cdn.xitu.io/2018/2/22/161bded1cb1b7ee3?w=507&h=517&f=png&s=11321)

_（图片来源：[W3C](https://www.w3.org/TR/css3-transitions/)）_

我们可以通过两种写法来实现例子中的逐帧动画，下面是第一种写法。

```
/* 写法一 */
.page_key {
  animation: p8 steps(1,end) 1.5s infinite;
}
@keyframes p8 {
  0% {background-position: 0 0;}
  33.33333% {background-position: 0 -206px;}
  66.66667% {background-position: 0 -412px;}
  100% {background-position: 0 -618px;}
}

```

这里可能有读者疑惑，`steps` 的第一个参数为什么是 1？

前文中提到，`steps` 是 `animation-timing-function` 的一个属性值，在 [W3C](https://www.w3.org/TR/css3-animations/#animation-timing-function-property) 中有如下说明：

> For a keyframed animation, the ‘animation-timing-function’ applies between keyframes, not over the entire animation.

也就是说，`animation-timing-function` 应用于两个关键帧（状态）之间，而非整个动画。在上面的 `keyframes` 中，我们已经把每个关键帧都写出来了，所以两个关键帧之间的间隔是 1。

既然 `steps` 第一个参数是指函数的间隔数量，那么我们就可以把 `keyframes` 的计算直接交给 `steps` 来完成。

```
/* 写法二 */
.page_key{
  animation: p8 steps(3,end) 1.5s infinite;
}
@keyframes p8 {
  100% {background-position: 0 -618px;}
}

```

上述两种写法最终的动画效果是相同的：

![最终效果](https://user-gold-cdn.xitu.io/2018/2/22/161bdf0064d07c2b?w=260&h=254&f=gif&s=16600)

至此，我们便实现了一个简单的 CSS3 逐帧动画，点击[查看 DEMO](http://jdc.jd.com/h5/daojia-demo/) 或扫描二维码：

![《年货送到家》](https://user-gold-cdn.xitu.io/2018/3/14/16224d442f9f2799?w=280&h=280&f=png&s=1534)

_[（京东年货到家逐帧动画 DEMO）](http://jdc.jd.com/h5/daojia-demo/)_

### CSS3 逐帧动画的一些技巧

CSS3 实现逐帧动画虽然简单，但也不乏技巧。

#### 1\. `step-start` 与 `step-end`

除了 `steps` 函数，`animation-timing-function` 还有两个与逐帧动画相关的属性值 `step-start` 与 `step-end`。

*   `step-start` 等同于 `steps(1, start)`：动画执行时以开始端点为开始。
*   `step-end` 等同于 `steps(1, end)`：动画执行时以结尾端点为开始。

#### 2\. 使用 Sass 完成动画帧的计算

```
/* 写法一 */
@mixin frame($frameNum, $frameHeight) {
  @for $i from 0 through $frameNum {
    #{100/$frameNum*$i}% {background-position: 0 #{-$i*$frameHeight}px;}
  }
}
/* 写法二 */
@mixin frame($frameNum, $frameHeight) {
  100% {background-position: 0 #{-$frameNum*$frameHeight}px;}
}

@keyframes p8 {
  @include frame($frameNum: 3, $frameHeight: 206)
}

```

#### 3\. 移动端使用 rem 配合 scale 适配，防止动画抖动

我们知道，`rem` 的计算会存在误差，因此使用雪碧图时我们并不推荐用 `rem`。

如果是逐帧动画的话，由于计算的误差，可能会出现动画抖动的情况。

为了解决这个问题，可以参考以下的适配思路：

*   非逐帧动画部分，使用 `rem` 做单位
*   逐帧动画部分，使用 `px` 做单位，再结合 JavaScript 对动画部分使用 `scale` 进行缩放

另外也可以通过 SVG 来解决抖动的问题，有兴趣可移步[《CSS 技巧：逐帧动画抖动解决方案》](https://aotu.io/notes/2017/08/14/fix-sprite-anim/) 做进一步的了解。

## 案例实战 2 - 利用 Canvas 做一个会动的京东 JOY

CSS3 实现的逐帧动画，如果它的帧数较多或尺寸较大时，移动端可能会存在渲染性能问题，此时建议改用 Canvas 实现。 相对于 CSS3 来说，Canvas 具有更高的学习成本，所以实际项目中推荐使用业务成熟的 Canvas 动画库，如 [CreateJS](https://www.createjs.com/)、[Pixi.js](http://pixijs.com) 等。

下面我们以 [「京东 JOY 福星会场 一一 八仙乐游记」](https://h5.m.jd.com/dev/oj4d4FHfrtsP4tqT7ukC9spRX85/index.html) 中的其中一个动画为例，为大家讲解如何利用 Canvas 实现逐帧动画。

![上图](https://user-gold-cdn.xitu.io/2018/3/14/162239dec61fe32a?w=320&h=320&f=gif&s=869595)

### 步骤 1 - 准备动画帧所需的雪碧图

在前面的案例中我们介绍了通过 Photoshop 手动合成雪碧图的方式，这里我们使用 [TexturePacker](https://www.codeandweb.com/texturepacker) 工具（付费软件，帧动画开发利器，值得购买）来更快地完成同样的事情。

![TexturePacker 用户界面](https://user-gold-cdn.xitu.io/2018/3/14/16223774fc46a5c7?w=2000&h=1362&f=png&s=455019)

_（TexturePacker 用户界面）_

[TexturePacker](https://www.codeandweb.com/texturepacker) 导出雪碧图的步骤如下：

1.  将逐帧动画所有帧拖到 TexturePacker
2.  选择逐帧动画的渲染载体（标记1）
3.  根据需要设置其余配置，如：当雪碧图超过 1 张时，请选择 `Multipack` 选项（标记2）
4.  点击 Publish sprite sheet（标记4）即可导出雪碧图和相应渲染载体的数据（若有）

预览逐帧动画的步骤：

1. 选择所有帧

   选择左侧 Sprites 面板其中一帧，然后按 Cmd/Ctrl + A 全选所有帧；或者拖拽选择所有帧。

2. 点击 Anim preview（标记3）

   如果我们选了渲染载体为 **EaselJS / CreateJS**， 其导出的 JSON 文件如下：

```
{
  "images": [
    "hxr-0.png",
    "hxr-1.png",
    "hxr-2.png",
    "hxr-3.png",
    "hxr-4.png",
    "hxr-5.png"
  ],

  "framerate": 20,
  "frames": [
    [1, 1, 519, 535, 0, -109, -499],
    [522, 1, 514, 538, 0, -108, -499],
    [1, 538, 514, 538, 0, -109, -499],
    ...
  ],

  "animations": {
    "花想容": { "frames": [45, 34, 36, 39, 41, 42, 43, 27, 44, 15, 30, 16, 17, 18, 21, 23, 24, 9, 12, 14, 19, 1, 2, 4, 5, 7, 10, 11, 13, 20, 31, 22, 25, 35, 28, 29, 32, 37, 38, 40, 33, 26, 8, 6, 0, 3] }
  },

  "texturepacker": [
    "SmartUpdateHash: $TexturePacker:SmartUpdate:d81882f9ddc9b1a6b4cc21c262ac0125:4ebba912052ed522502e73edaa8a5333:c8130f68479de7028295f1ccf1a4ea15$",
    "Created with TexturePacker (https://www.codeandweb.com/texturepacker) for EaselJS"
  ]
}

```

[TexturePacker](https://www.codeandweb.com/texturepacker) 除了生成雪碧图，其导出的 JSON 文件其实还包含了逐帧动画所需的运行数据，只需结合渲染载体的相应 API 即可快速实现逐帧动画。

### 步骤 2 - 实现动画

以 CreateJS 为例。

准备 HTML:

```
<canvas id="hxr-canvas" width="526" height="536"></canvas>

```

准备 CreateJS 代码：

```
var hxrCanvas = document.getElementById("hxr-canvas")
var hxrStage = new createjs.Stage(hxrCanvas)

// 将上 JSON 数据进行修改：如 "images" 和 "animations" 字段
var spriteSheet = new createjs.SpriteSheet({
  "images": [
    preload.getResult('hxr0'),
    preload.getResult('hxr1'),
    preload.getResult('hxr2'),
    preload.getResult('hxr3'),
    preload.getResult('hxr4'),
    preload.getResult('hxr5'),
  ],

  "framerate": 20,
  "frames": [
    [1, 1, 519, 535, 0, -109, -499],
    [522, 1, 514, 538, 0, -108, -499],
    [1, 538, 514, 538, 0, -109, -499],
    ...
  ],

  "animations": {
    "play": { "frames": [45, 34, 36, 39, 41, 42, 43, 27, 44, 15, 30, 16, 17, 18, 21, 23, 24, 9, 12, 14, 19, 1, 2, 4, 5, 7, 10, 11, 13, 20, 31, 22, 25, 35, 28, 29, 32, 37, 38, 40, 33, 26, 8, 6, 0, 3] }
  },
})

hxrSprite = new createjs.Sprite(spriteSheet)
hxrSprite.x = 0
hxrSprite.y = 0
hxrStage.addChild(hxrSprite)
hxrSprite.gotoAndPlay("play") // 播放指定的动作 "play"

```

这样即可完成一个逐帧动画，[点击体验 DEMO](https://h5.m.jd.com/dev/22Vp3Q5pX2rvuPwDYeDWjPoF3Ahf/index.html) ，或扫描二维码：

![Canvas 逐帧动画 DEMO](https://user-gold-cdn.xitu.io/2018/3/14/16223a3039225360?w=280&h=280&f=png&s=2021)

_[（ Canvas 逐帧动画 DEMO ）](https://h5.m.jd.com/dev/22Vp3Q5pX2rvuPwDYeDWjPoF3Ahf/index.html)_

### 相关资源下载

*   [逐帧动画源文件](http://omwfrl50f.bkt.clouddn.com/xiaocezi/frame.zip)（用于 TexturePacker 合成）
*   [TexturePacker 导出后的文件](http://omwfrl50f.bkt.clouddn.com/xiaocezi/hxr.zip)（适用于未购买 TexturePacker 的读者）
*   [案例 2 完整项目源码](https://coding.net/u/Jcc/p/canvas-sprite/git?public=true)

## 小结

本小节结合案例为大家讲解了两种最为常见的逐帧动画实现方案：「基于 CSS3 Animation 实现逐帧动画」和「基于 Canvas 实现逐帧动画」。考虑到 Canvas 的方案需要引入第三方的脚本库（以 CreateJS 为例，引入的脚本库体积大小在 190 多 KB，GZIP 后仍然有 50 多 KB），在实际工作过程中，应尽量使用 CSS3 来实现逐帧动画，当 CSS3 实现的逐帧动画出现性能体验问题（或预估到会有此类问题）时，再考虑使用 Canvas 的实现方案。

# 九、动效开发 5：SVG 动画

CSS3 动画已然足够强大，不过还是有一些它做不到的地方，例如轨迹（路径）动画的实现。配合 SVG，可以让 Web 动效有更多的可能性。

## 案例实战 - 实现一个购物袋的 loading 动效

下面以一个购物袋的 loading 动效为示例，带领大家上手 SVG 动画。

![效果](https://user-gold-cdn.xitu.io/2018/2/22/161be0fc40cc3301?w=301&h=233&f=gif&s=60669)

其中旋转通过 CSS 来完成，但是旋转之后圆弧缩短变成笑脸的嘴巴需要借助 SVG 来实现。

### 步骤 1 - 声明 SVG 视窗

```
<svg width="100" height=“100”></svg>

```

指定一个宽高都为 100 像素的区域，`width="100"` 和 `width="100px"` 是等价的，当然也可以使用其他的合法单位，例如 cm、mm、em 等。

阅读器会设置一个默认的坐标系统，见下图：左上角为原点，其中水平（x）坐标向右递增，垂直（y）坐标向下递增。

![坐标系统](https://user-gold-cdn.xitu.io/2018/2/22/161be10cc3f5fc0e?w=359&h=276&f=png&s=8037)

在没有指定的情况下，所有数值的默认单位都是像素。

### 步骤 2 - 绘制购物袋

购物袋由两个部分组成，先画下面的主体：

```
<path d="M 20 40 L 80 40 L 80 90 A 10 10 90 0 1 70 100 L 30 100 A 10 10 90 0 1 20 90" style="fill: #e9e8ee;" />

```

任何形状都可以使用路径元素画出，描述轮廓的数据放在它的 `d` 属性中。

* 样式中的 `fill` 用来设置填充色

* 路径数据由命令和坐标构成

  指令

  说明

  M 20 40

  表示移动画笔到 (20,40)

  L 80 40

  表示绘制一条线到 (80, 40)

  A 10 10 90 0 1 70 100

  绘制一个椭圆弧

圆弧命令以字母 A 开始，后面紧跟着 7 个参数，这 7 个参数分别用来表示：

1.  椭圆的 x 半径和 y 半径
2.  椭圆的 x 轴旋转角度
3.  圆弧的角度小于 180 度，为 0；大于或等于 180 度，则为 1
4.  以负角度绘制为 0，否则为 1
5.  终点的x、y坐标

![图片](https://user-gold-cdn.xitu.io/2018/2/22/161be16aaf4efee4?w=335&h=289&f=png&s=8581)

接下来绘制购物袋上面的部分：

```
<path d="M 35 40 A 15 15 180 1 1 65 40" style="fill: none; stroke: #e9e8ee; stroke-width: 5;” />

```

上面的部分是一个半圆弧，同样用路径来画出，当然也可以使用基础形状来完成。

样式中的 `stoke` 和 `stroke-width` 分别用来设置描边色和描边的宽度。

![图片](https://user-gold-cdn.xitu.io/2018/2/22/161be172ffcd05d7?w=305&h=286&f=png&s=9394)

### 步骤 3 - 绘制眼睛

```
<circle cx=“40" cy="60" r="2.5" style="fill: #fff;" />
<circle cx="60" cy="60" r="2.5" style="fill: #fff;" />

```

使用基础形状，画两个小圆点。四个属性分别是位置坐标、半径和填充颜色。

![绘制眼睛](https://user-gold-cdn.xitu.io/2018/2/22/161be17aa1fd5568?w=297&h=287&f=png&s=9577)

### 步骤 4 - 绘制嘴巴

```
<circle cx="50" cy="70" r="15" style="fill: none; stroke: #fff; stroke-width: 5; stroke-linecap: round;transform: rotate(280deg); transform-origin: 50% 50%; stroke-dashoffset: -23; stroke-dasharray: 42, 95;”>

```

嘴巴是一段圆弧，我绘制了一个圆，然后描边了其中的一段，并且做了一个旋转，来让它的角度处于正确的位置。

> 1.  `stroke-linecap`：用来定义开放路径的终结,可选 `round|butt|square`
> 2.  `stroke-dasharray`：用来创建虚线
> 3.  `stroke-dashoffset`：设置虚线位置的起始偏移值，在下一个步骤里，它会和 `stroke-dasharray` 一起用来实现动效

![绘制嘴巴](https://user-gold-cdn.xitu.io/2018/2/22/161be1948afec303?w=314&h=285&f=png&s=10645)

### 步骤 5 - 给嘴巴部分添加动效

```
@keyframes mouth {
 0% {
  transform: rotate(-80deg);
  stroke-dasharray: 60, 95;
  stroke-dashoffset: 0;
 }
 40% {
  transform: rotate(280deg);
  stroke-dasharray: 60, 95;
  stroke-dashoffset: 0;
 }
 70%, 100% {
  transform: rotate(280deg);
  stroke-dashoffset: -23;
  stroke-dasharray: 42, 95;
 }
}

```

动画分为两个部分：

1.  圆弧旋转
2.  旋转之后缩短变形

在一个循环里，最后留有 30% 的时间保持一个停留状态。

![嘴巴动画](https://user-gold-cdn.xitu.io/2018/2/22/161be1af387d088a?w=354&h=282&f=gif&s=76664)

### 步骤 6 - 给眼睛添加动画

两只眼睛都是沿着圆弧运动 ，例如左眼，首先用一个路径来规定它的运动轨迹：

```
<path id="eyeright" d="M 40 60 A 15 15 180 0 1 60 60" style="fill: none; stroke-width: 0;" />

```

然后使用 `animateMotion` 来设置动画：

```
<circle class="eye" cx="" cy="" r="2.5" style="fill: #fff;">
 <animateMotion
  dur="0.8s"
  repeatCount="indefinite"
  keyPoints="0;0;1;1"
  keyTimes="0;0.3;0.9;1"
  calcMode="linear">
  <mpath xlink:href="#eyeleft"/>
 </animateMotion>
</circle>

```

> 1.  `dur`：动画的时间
> 2.  `repeatCount`：重复次数
> 3.  `keyPoints`：运动路径的关键点
> 4.  `timePoints`：时间的关键点
> 5.  `calcMode`：控制动画的运动速率的变化，`discrete` | `linear` | `paced` | `spline` 四个属性可选
> 6.  `mpath`：指定一个外部定义的路径

![眼睛动画](https://user-gold-cdn.xitu.io/2018/2/22/161be1c4cccfb106?w=354&h=282&f=gif&s=62795)

### 步骤 7 - 将不同部位的动画组合到一起

*   眼睛的动画是从嘴巴旋转完成开始，到嘴巴变形完成结束，因此和嘴巴的动画一样，设置了四个对应的关键时间点。
*   为了让衔接更顺畅，眼睛的动画开始比嘴巴变形开始稍微提前了一点点。

![最终效果](https://user-gold-cdn.xitu.io/2018/2/22/161be1d04dfd4f3a?w=354&h=282&f=gif&s=101961)

Bingo！小功告成！[查看 DEMO](http://jdc.jd.com/demo/simba/loading/index.html)

## 初探 SMIL

[SMIL](https://www.w3.org/TR/REC-smil/) 的全称为 Synchronized Multimedia Integration Language（同步多媒体集成语言），按照 W3C 规范对 SMIL 的描述，它是一种允许用户在网页上定义可交互多媒体内容的 XML 语言，可结合 XHTML 和 SVG 一起使用来实现网页动态效果。

在上面的案例中，我们使用了一个名为 `animateMotion` 的元素来实现眼睛的轨迹动画，其实便属于 SMIL 的知识范畴。

除了 `animationMotion` 用于实现轨迹动画之外，SMIL 还提供了另外两个元素来定义父级对象的动画，分别为：

*   `animate`：用于设置父元素的数值属性（如 `width`、`height`、`color` 等）的过渡动画
*   `animateTransform`：用于设置父元素的 `transform` 属性的过渡动画

### SMIL 的兼容性

除了微软系浏览器 及 Opera Mini 外，其他主流浏览器均支持 SMIL。

![SMIL CAN I USE](https://user-gold-cdn.xitu.io/2018/3/14/1622414dfb24f7ff?w=1200&h=257&f=jpeg&s=49621)

_（数据来源：[caniuse.com](https://caniuse.com/#search=SMIL)，截至 2018 年 3 月 14 日）_

> Chrome 45 版本曾声称准备弃用 SMIL ，但随后撤回了弃用计划。

### SMIL 的一个小例子

如下利用 SMIL 同时改变圆的位置和颜色：

```
<svg width="100%" height="90" viewPort="0 0 90 90" class="demo-item">
    <circle cx="55" cy="45" r="45">
      <animate attributeType="XML" attributeName="cx" from="55" to="100%"
          dur="5s" repeatCount="indefinite"/>
      <animate attributeType="XML" attributeName="fill" from="#6190e8" to="#23232e"
          dur="5s" repeatCount="indefinite"/>
    </circle>
</svg>

```

可见 SMIL 的动画元素是可以叠加使用的，[查看 DEMO](https://codepen.io/mamboer/full/MVKRZJ)。

## 扩展阅读

*   [Animating SVG with CSS](https://css-tricks.com/animating-svg-css/)：利用 SVG 结合 CSS 实现一个动态广告图
*   [Creating Cel Animations With SVG](https://www.smashingmagazine.com/2015/09/creating-cel-animations-with-svg/)：利用 SVG 结合 CSS 实现逐帧（定格）动画
*   [Cel Animation](https://github.com/Heydon/cel-animation)：用于辅助实现 SVG 逐帧（定格）动画的一个 SASS @mixin 函数
*   [SVG - animationMotion](https://developer.mozilla.org/en-US/docs/Web/SVG/Element/animateMotion)：了解 `animationMotion` 元素
*   [SVG animation with SMIL](https://developer.mozilla.org/en-US/docs/Web/SVG/SVG_animation_with_SMIL)：了解使用 SMIL 实现 SVG 动画的方法

## 小结

SVG 在网页中的角色更像是类似图片一样的媒体对象，其动画也常常和 CSS 有关联，当然利用 [SMIL](https://developer.mozilla.org/en-US/docs/Web/SVG/SVG_animation_with_SMIL) 仍然可以为 SVG 添加独立的动效，除了微软系的浏览器不支持之外，其兼容性还是相当可观的。在平时工作过程中，矢量图标的动画、轨迹动画特别适合使用 SVG 来实现。

# 十、动效开发 6：动效之效

回头看看，我们花了 5 个小节来啰唆「动效开发」的「动」：

*   如何动 —— 第 5 小节《让它动起来》
*   立体地动 —— 第 6 小节《聊一聊 3D》
*   让浏览器帮忙动 —— 第 7 小节《补间动画》
*   一帧一帧地动 —— 第 8 小节《逐帧动画》
*   让 SVG 动 —— 第 9 小节《SVG 动画》

我们花费力气去做的事情毋庸置疑是重要的，但它距离突破也许还差一点别的东西。就好比一个歌手拼命练习各种花式唱法 —— 高音、颤音、延音无所不能，但缺了情感就算不上伟大的歌手。动效开发也是一样的道理，「动」是招式是基本要求，而「效」才是真正的修炼之道。

我们思考动效之「效」，其实就是要思考如何让我们做出来的动画具备最佳的体验效果，它包括两个方面的内容：

*   感官体验 —— 如何「动」得自然、有情感、能吸引人？
*   物理性能 —— 如何「动」得更流畅？

> “要写 CSS3 动画，必先学技术。要写好 CSS3 动画，还是得深入探索传统动画的精华。”  
> —— EC，京东凹凸实验室首席动效开发

对于「如何提升动画的体验效果」这个话题，我们不妨先以电影之眼来看看 CSS3 动画，也许能从中窥得一些门道。

## 以电影之眼看 CSS3 动画

CSS3 动画的变形基础（transform）包含 4 种变形方式（`translate`、`rotate`、`scale`、`skew`），同时还可设置 2D、3D、变形原点（`transform-origin`）、透视（`perspective`）、透视原点（`perspective-origin`）等等特性；动画时间轴函数包含 9 种基本模式（`ease`、`linear`、`ease-in`、`ease-out`、`ease-in-out`、`step-start`、`step-end`、`steps`），甚至还可以使用 `cubic-bezier` 写出任何你想要的模式；再加上动画持续时间（`animation-duration`）等设定，各种排列组合，CSS3 动画简直拥有了整个世界。

![动画的时间掌握](https://user-gold-cdn.xitu.io/2018/3/5/161f548b6330de2f?w=500&h=247&f=png&s=72291)

_（图片源自《动画的时间掌握》）_

### 关键帧与时间轴

根据 [维基](http://zh.wikipedia.org/wiki/%E5%8A%A8%E7%94%BB) 的释义，动画是指由许多帧静止的画面，以一定的速度（如每秒 16 张）连续播放时，肉眼因视觉残象产生错觉，而误以为画面活动的作品（GIF 图片正是运用这种原理）。因此最初的动画是通过几张快速翻动的连续画面制作而成，而后经历了电影摄影技术的出现、电脑科技的进步，逐渐转向数字化。

![关键帧与时间轴](https://user-gold-cdn.xitu.io/2018/3/5/161f54b7dac3a43a?w=82&h=82&f=gif&s=2145)

将上面的 GIF 拖入 PS 之后打开时间轴窗口即可看到每一帧的画面：

![GIF 的每一帧](https://user-gold-cdn.xitu.io/2018/3/5/161f54c6ee0f6734?w=319&h=90&f=png&s=5815)

无论是 2D 还是 3D 动画，关键帧，正如其名，是动画制作中最关键的部分，同时也是最难把握的部分。曾经有位设计师告诉我，在大学的第一节 flash 课的课后作业，老师要求大家上交一份小球动画，包含气球、石球与皮球，并告诉大家，以相同的外观表现出不同的质感是在考验你对关键帧的悟性，而这一个作业就能体现你是否适合学习动画。

![球](https://user-gold-cdn.xitu.io/2018/3/5/161f54df5946384d?w=500&h=570&f=png&s=151320)

> A 需要很大的力才能使一个炮弹移动。一旦它移动了，同样需要很大的力才能阻挡它前进。  
> B 一只气球只需要很小的力去移动它，但空气阻力使它很快停止动作。  
> 这两个例子都画了动作分格线，可以看出在银幕上表现物体的轻重，取决于对它们动作的时间掌握。  
> ——《动画的时间掌握》

在[《动画制作流程介绍》](http://cghappening.blogspot.com/2011/02/blog-post_23.html)提供的视频中可以看到关键帧在动画制作中所起的地基般的作用。

![怪物公司的关键帧](https://user-gold-cdn.xitu.io/2018/3/5/161f5501d77b1a0c?w=319&h=226&f=gif&s=4227788)

_（画面上方的手绘图即为「怪物公司」的关键帧）_

与关键帧紧密关联的即为时间轴（或摄制表），时间轴是补齐中间帧不可或缺的一项，在传统动画制作中，导演就是通过制定时间轴来掌控整部动画的节奏的。

![摄制表](https://user-gold-cdn.xitu.io/2018/3/5/161f55107efc3a14?w=860&h=491&f=png&s=251263)

_（摄制表，图片来源：《动画的时间掌握》）_

在 CSS3 中，`@keyframes` 正是动画的关键帧容器。`@keyframes` 中包含的包括 `transform` 在内的元素形态设定构成了关键帧的画面。`@keyframes` 中的百分比即为时间轴的体现。中间帧则由浏览器自动完成（回顾第 7 小节的补间动画）。

现在我们知道了 CSS3 动画的结构与传统动画之间的关系，重点来了， CSS3 动画可以做出一部动画电影吗？

## 用 CSS3 动画做一部动画电影

现在就让我们来探讨一下用 CSS3 动画做一部吸引人的动画电影都需要些什么。

### 首先，你需要一个故事

首先你需要一个故事，即使只是一堆雪花往下掉，也是包含故事的——为什么下雪？是冬天来了？那是冬天的第一场雪吗？第一场雪有什么特点呢？好吧，作为一个从没见过雪的南方人，我承认我给自己挖了个坑，不过就是类似这种思路，让我们拥有了一个故事，所以，即使只有一秒钟的动画也是有故事的。Use your imagination.

> **小贴士**：在做影视题材的专题页时，我会首先根据相关影视的预告片确定入场动画的风格与基调，观看预告片不仅能够了解影片的风格，同时还能学习其字幕出现、消失以及转场的方式，获得一种节奏感，也就是上面所说的时间掌控。在看电影正片时也可留意影片开头与结尾字幕出现的形式，尤其是科幻片，电影字幕的设计与电影风格相辅相成，常常能让你脑洞大开——原来还能这么玩。

![窃听风云3](https://user-gold-cdn.xitu.io/2018/3/5/161f559139c1a339?w=718&h=397&f=gif&s=3933347)

[\[窃听风云3\]预告片](http://movie.douban.com/trailer/156598/#content) 中字幕出现的方式表现出信号干扰的效果，由此可以将影片相关专题作出这样的开场动画——

![窃听风云3](https://user-gold-cdn.xitu.io/2018/3/5/161f55894e8dac08?w=520&h=317&f=gif&s=2894038)

简单的几个不同色调的图片进行替换就能做出类似效果，代码也灰常简单（看 [demo](http://jdc.jd.com/demo/ec/movieeye/doing_movie_by_css3.html)）：

```
@keyframes peoInner{
	0%, 12.5%, 16.5%, 20.5% { background:none; }
	10%, 12% { background:url(../img_bg/casts_adv_green_red.jpg) no-repeat 0 0; }
	14%, 16% { background:url(../img_bg/casts_adv_green_red.jpg) no-repeat 0 -725px; }
	18%, 20% { background:url(../img_bg/casts_adv_green_red.jpg) no-repeat 0 -725px; }
	13%, 17%, 21%, 100% { background:url(../img_bg/cast_adv_01.jpg) no-repeat top center; }
}

```

但是，需要注意的是，这种变换 `background` 的动画方式属于页面性能中的大忌，不建议使用。可使用多个 DOM 结点控制透明度动画来实现同样的效果。

### 设计关键帧与时间轴

当我们在脑内小剧场构思好动画小故事之后（当然，你也可以将它写下来），我们就可以进行关键帧与时间轴的设计了。

> 任何人都可以用电脑动画软件将一个物体移动。  
> 但是如何赋予物体重量、大小、规模、移动和幽默感，这些都与你如何移动物体相关。  
> 电脑不能为动画师创造动画，动画师仍然需要了解时间掌握的原则知识以赋予电脑动画生命力。  
> ——《动画的时间掌握》

这时需要注意的是因果关系对动画的影响，“一个动画师必须懂得自然界物体运动的力学知识”，这样“才能创造情绪和表达正确的感觉。” 我们来看看为了使动画更加流畅真实，迪士尼爷爷想出了什么办法。「白雪公主与七个小矮人」作为 80、90 后动画电影启蒙，使用了一项革新动画制作的技术——[转描机](http://zh.wikipedia.org/wiki/%E8%BD%AC%E6%8F%8F%E6%9C%BA%E6%8A%80%E6%9C%AF)。

![转描机](https://user-gold-cdn.xitu.io/2018/3/5/161f5799d8dee2b0?w=400&h=280&f=gif&s=7797119)

_（图片来源：视频 [【DizAvenue】制作白雪公主的故事 The Making of Snow White](https://www.bilibili.com/video/av19937746/)）_

#### 迪士尼动画十二原则的运用

视频中有一个细节，迪士尼爷爷让动画师注意那位大叔在跳踢踏舞时重力对裤腿的作用（20 分 20 秒）。是的，迪士尼爷爷强调的就是动画与物理学的关系。

迪士尼工作室在早期，将他们在动画实践中所总结出的规律总结成为了经典的[《动画12原则》](https://zh.wikipedia.org/wiki/%E5%8B%95%E7%95%AB%E7%9A%8412%E9%A0%85%E5%9F%BA%E6%9C%AC%E6%B3%95%E5%89%87)，可以说这 12 原则就是让迪士尼动画在当时脱颖而出的黄金原则，即便是现如今看来，这 12 原则也并不过时，甚至可以扩展运用至网页交互动效中。

![迪士尼十二原则](https://user-gold-cdn.xitu.io/2018/3/5/161f659186f325fa?w=1039&h=285&f=png&s=105616)

依其第 5 条「动作的惯性跟随和重叠」，我们可以将网页元素看作一个有重量、有结构、有柔韧性的物体进行动画设计，会得到意想不到的效果。事实上已经有人这么做了——

![dribbble’s stripe checkout](https://user-gold-cdn.xitu.io/2018/3/5/161f57b19390c352?w=467&h=488&f=gif&s=2044217)

_（dribbble’s stripe checkout，图片来源：[The Art of Animation](http://markgeyer.com/pres/the-art-of-ui-animations/#/2/9)）_

![Giving Animations Life](https://user-gold-cdn.xitu.io/2018/3/5/161f57b9c771658c?w=396&h=534&f=gif&s=1328667)

_（图片来源：[Giving Animations Life](https://medium.com/tictail-makers/giving-animations-life-8b20165224c5)）_

在实现过程中，我们可以选择合适的时间轴函数来达成这些效果，或者使用 [Bounce.js](http://bouncejs.com/) 这样的弹性动效库，给元素加上弹性动效后，通常能够事半功倍地增加动效的活力与吸引力，但同样的，过犹不及，一切动效的添加都要讲究适度。

对于时间轴函数之贝塞尔曲线的应用，笔者推荐两个工具：[贝塞尔曲线在线调试工具](http://cubic-bezier.com/#.17,.67,.83,.67) 以及 [贝塞尔缓动函数库](http://easings.net/zh-cn#)，能够帮助大家快速选取合适的贝塞尔曲线函数。

其第 8 条「次要动作」，在案例《拍拍七夕活动页－七叻个夕》中就得到应用（目前案例已下线），如下图所示：

![次要动作](https://user-gold-cdn.xitu.io/2018/3/5/161f65c1a1714a19?w=650&h=568&f=gif&s=357930)

头花的颤抖的次要动作的加入，不仅衬托得人物的抖动的主要动作更加生动、真实，还令人物情绪的体现更加饱满、感觉更有生命力。

对于这十二条原则的进一步学习，笔者推荐[《入门必读！迪士尼影响至今的十二条动画经典法则 》](http://www.zcool.com.cn/article/ZNDI1ODAw.html) 一文，里面介绍了每条法则的具体内容，必定能让你有所受益。

#### 对动画过渡时间的把握

Google 在 Material Design 指南中提及 [动效过渡时间](https://material.io/guidelines/motion/duration-easing.html#duration-easing-speed)：对于用于交互操作场景的补间动画而言，短动画时间应该控制在 150～200ms，而长动画控制在 300～400ms。而对于用于呈现场景的补间动画则视具体而定，以真实世界为参考标准是最好的。

### 不断地修改与调整

这是一个需要细致与耐心的过程，你得在不断的调整中保持大局观，避免陷入细节的纠结，同时又需要有能够将别扭的细节调整好的灵感。说白了就是同时拥有汉子的粗犷与妹子的细腻。节奏是一个很重要的因素，与银幕上的动画类似，CSS3 动画创作者的意念必须即时并完全交给观众。

意念清晰易懂靠两个因素：

> (1) 好的表现手法和设计，要使每个主要动作能以最清楚和最有效的方式呈现在银幕上。  
> (2) 好的时间掌握，要有足够的时间先使用户预感到将有什么事情发生，然后用于表现动作本身，最后要有好的收尾。 这三者中，任何一项所占时间太多，便会感觉节奏太慢，用户会感到不耐烦，动画的出现便如同鸡肋。 反之，如果时间太短，那么用户在注意到它之前，动作已经结束，创作者的意念未能充分表达，就浪费掉了。  
> ——《动画的时间掌握》

## 别忘了性能测试

这是有可能推翻前面两步甚至三步的一个步骤。不过即便发生了这样的事，也不要气馁，这并不意味着之前做的前功尽弃，反而是个宝贵的财富——对于性能的感受又多了一次体验，而其中的一些动画心得或许下次能用上。

### 别只专注于动画的实现

![Pseudo-Elements Animations and Transitions](https://user-gold-cdn.xitu.io/2018/3/5/161f57d943bf5ae0?w=194&h=83&f=gif&s=560994)

_（动画来源：[Pseudo-Elements Animations and Transitions](http://tympanus.net/Development/PseudoElementsAnimationsTransitions/index4.html)）_

这是个使用最简单的 CSS 属性 —— `padding`、`line-height`、`box-shadow` 实现了令人吃了一斤效果的栗子，就像一道脑筋急转弯一样，让大家对 CSS3 动画的理解不止于 CSS3 的新属性，我们曾经用烂的 CSS2.0 属性同样也能开出花儿。然而，这个例子所用的 CSS 属性对于性能的影响并不适用于生产环境。

### 更高效的 CSS 属性

我们知道，页面渲染的一般过程为 `JS > CSS > 计算样式 > 布局 > 绘制 > 渲染层合并`，如下图所示：

![页面渲染](https://user-gold-cdn.xitu.io/2018/3/5/161f65e6fb4c861a?w=1093&h=167&f=png&s=33641)

其中，Layout（重排）和 Paint（重绘） 是整个环节中最为耗时的两环，所以我们应尽量避免使用触发这两个环节的 CSS 属性。

例如，最基本的一个注意点是：使用切换类名的方式来触发动画，而不是使用 `diaplay: none` 属性值，因为它会引起相关元素的重排和重绘。

除此之外，下面几个属性的替换使用也是值得推荐的：

*   `translate` 属性替换 `top/left/right/bottom`
*   `scale` 属性换 `width/height`
*   `opacity` 属性替换 `display/visibility`

笔者这里推荐 [CSS Triggers](http://csstriggers.com/)，通过它你可以查阅到各 CSS 属性及其影响的环节，从而避免不小心使用到性能开销较大的属性。

除此之外，对动画渲染的优化还有其他方式，这里抛出 @登平登平 在 [《H5 动画 60fps 之路》](https://weibo.com/p/1001603865643593165786)一文中的总结，同学们可以前往原文进行进一步的学习。

![H5 动画 60fps 之路](https://user-gold-cdn.xitu.io/2018/3/5/161f66575fbbb137?w=1632&h=628&f=png&s=375991)

## 扩展阅读

*   [《入门必读！迪士尼影响至今的十二条动画经典法则 》](http://www.zcool.com.cn/article/ZNDI1ODAw.html) —— 详细了解迪士尼十二条动画经典法则
*   [《让界面动画更自然－ISUX》](http://blog.jobbole.com/76194/) —— 如何合理选用动画曲线函数
*   [贝塞尔曲线在线调试工具](http://cubic-bezier.com/#.17,.67,.83,.67) 以及 [贝塞尔缓动函数库](http://easings.net/zh-cn#) —— 帮助你快速选取合适的贝塞尔曲线函数
*   [The Guide To CSS Animation: Principles and Examples](https://www.smashingmagazine.com/2011/09/the-guide-to-css-animation-principles-and-examples/) —— 很老的一篇英文文章，以示例的方式介绍了迪士尼的十二条动画法则

## 小结

我们看到，CSS3 动画并不只是由 `transform`、`opacity` 等简单组成，它还可以包含许许多多的设计、想法、甚至感情。「台上一分钟，台下十年功」这句话在动效开发上也适用，或许在所有事物上都适用。

目前为止，用 CSS3 动画拍电影只是个概念，但想象一下你是这部电影的导演，所有元素都是可调度的场景与角色，用 CSS3 动画拍电影是不是也没有那么遥远了？

最后，放上迪士尼爷爷的一段话，在我做动画甚至做任何事时它将不断地在脑海中回响。

曾经有人问迪士尼，「白雪公主」大受欢迎的秘密是什么？他回答说：

> “我们只能确定一件事，每一个人都有童年，每次拍一部新片，我们不是为大人而拍，也不只是为小孩子拍，我们是为了唤醒每个人内心深处那种早就被遗忘的纯真世界。”

# 十一、总结

![H5 开发能力模型](https://user-gold-cdn.xitu.io/2018/3/6/161f90458e69df9b?w=1442&h=536&f=jpeg&s=38516)

总算写到了这里，围绕「H5 开发」的四大能力，小册的所有内容便已算告“终”了，看完所有内容的你不知道现在对于下面的问题是否有了清晰的答案。

> 我拿出什么样的作品（或能力），才能真正满足「H5 开发」相关岗位的要求，使得我去面试的时候，至少技术面（专业能力）是完全过关的？

这「终」字带了引号，因为我们会随时回来修订，包括但不限于：

*   大家提出的问题反馈、修改意见
*   结合时下最新的专业内容更新相关章节
*   围绕「H5 开发」添加新的内容

「H5 开发」是一个前端职业方向，其涵义会随着时代的更迭而更迭， 我们为大家撰写的这本小册也同样如此，「内容与时俱进」是我们对所有读者的一个小小的承诺，希望大家现在觉得它有用，至少指明了一个方向，两三年后再回头翻看它时也仍然觉得它有价值。从这个角度来看，这「终」其实是一个新的开始 —— 我们和大家一起交流进步的开始。

最后我想感谢小册内容的所有贡献者：Koppt、JC、EC、大婷、小婷、陈老湿、AV，你们的内容与经验孕育了小册本身。几个人一起写一本小册的难度肯定要比一个人写来的高，每个人的笔墨风格各异，排版喜好不一，幸好我们的目标是一致的，围绕着「H5 开发」这个主题，一起努力做了串联整合，降低多人协作对内容组织的整体影响，尽力保证小册的阅读体验。

同时感谢掘金提供的小册平台。

希望这本小册能成为你们海海编程人生中的小小体验。

## 书中的示例及源码

小册里面的例子比较分散，为了方便大家学习，已做了一个例子和源码的聚合页，请 [猛击这里](https://books.aotu.io/notes/2018/03/15/uidev/#%E4%B9%A6%E4%B8%AD%E7%A4%BA%E4%BE%8B) ！